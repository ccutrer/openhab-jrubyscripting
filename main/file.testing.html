<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: Testing Your Rules
  
    &mdash; Documentation by YARD 0.9.28
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "testing";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: Testing Your Rules</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1>Testing</h1>
<p><code>openhab-jrubyscripting</code> includes framework classes to allow you to write unit tests
for your openHAB rules written in JRuby. It loads up a limited actual openHAB runtime
environment. Because it is a limited environment, with no actual bindings or things,
you may need to stub out those actions in your tests. The autoupdate manager is
running, so any commands sent to items that aren't marked as <code>autoupdate=&quot;false&quot;</code> will
update automatically.</p>
<h2>Usage</h2>
<p>You must run tests on a system with an actual openHAB instance installed, with your
configuration. JRuby &gt;= 9.3.8.0 must also be installed.</p>
<ul>
<li>Install and activate JRuby (by your method of choice - chruby, rbenv, etc.).</li>
<li>Either create an empty directory, or use <code>$OPENHAB_CONF</code> itself (the former
is untested)</li>
<li>Create a <code>Gemfile</code> with the following contents (or add to an existing one):</li>
</ul>
<pre class="code ruby"><code class="ruby">source <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">https://rubygems.org</span><span style="color:#710">&quot;</span></span>

group(<span style="color:#A60">:test</span>) <span style="color:#080;font-weight:bold">do</span>
  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">rspec</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">~&gt; 3.11</span><span style="color:#710">&quot;</span></span>
  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openhab-jrubyscripting</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">~&gt; 0.1</span><span style="color:#710">&quot;</span></span>
  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">timecop</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>

group(<span style="color:#A60">:rules</span>) <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># include any gems you reference from `gemfile` calls in your rules so that</span>
  <span style="color:#777"># they'll already be available in the rules, and won't need to be</span>
  <span style="color:#777"># re-installed on every run, slowing down spec runs considerably</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<ul>
<li>Run <code>gem install bundler</code></li>
<li>Run <code>bundle install</code></li>
<li>Run <code>bundle exec rspec --init</code></li>
<li>Edit the generated <code>spec/spec_helper.rb</code> to satisfy your preferences, and
add:</li>
</ul>
<pre class="code ruby"><code class="ruby">require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">rubygems</span><span style="color:#710">&quot;</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">bundler</span><span style="color:#710">&quot;</span></span>

<span style="color:#036;font-weight:bold">Bundler</span>.require(<span style="color:#A60">:default</span>, <span style="color:#A60">:test</span>)

require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openhab/rspec</span><span style="color:#710">&quot;</span></span>

<span style="color:#777"># if you have any automatic requires setup in jrubyscripting's config,</span>
<span style="color:#777"># (besides `openhab`), you need to manually require them here</span>
</code></pre>
<ul>
<li>Create some specs! An example of <code>spec/switches_spec.rb</code>:</li>
</ul>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">RSpec</span>.describe <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">switches.rb</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  describe <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">gFullOn</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
    it <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">works</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
      <span style="color:#036;font-weight:bold">GuestCans_Dimmer</span>.update(<span style="color:#00D">0</span>)
      <span style="color:#036;font-weight:bold">GuestCans_Scene</span>.update(<span style="color:#60E">1.3</span>)
      expect(<span style="color:#036;font-weight:bold">GuestCans_Dimmer</span>.state).to eq <span style="color:#00D">100</span>
    <span style="color:#080;font-weight:bold">end</span>

    it <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">sets some state</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
      rules[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my rule</span><span style="color:#710">&quot;</span></span>].trigger
      expect(<span style="color:#036;font-weight:bold">GuestCans_Scene</span>.state).to be_nil
    <span style="color:#080;font-weight:bold">end</span>

    it <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">triggers a rule expecting an event</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
      rules[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my rule 2</span><span style="color:#710">&quot;</span></span>].trigger(<span style="color:#036;font-weight:bold">Struct</span>.new(<span style="color:#A60">:item</span>).new(<span style="color:#036;font-weight:bold">GuestCans_Scene</span>))
      expect(<span style="color:#036;font-weight:bold">GuestCans_Scene</span>.state).to be_nil
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<ul>
<li>Run your specs: <code>bundle exec rspec</code></li>
</ul>
<p>Bonus, if you want to play in a sandbox to explore what's available (either for
specs or for writing rules) via a REPL, run <code>bundle console</code>, and inside of that
run <code>Bundler.require(:test)</code>. It will first load up the openHAB dependencies,
and then load rules in, then drop you into IRB.</p>
<h3>Spec Writing Tips</h3>
<ul>
<li>See <span class='object_link'><a href="OpenHAB/RSpec/Helpers.html" title="OpenHAB::RSpec::Helpers (module)">OpenHAB::RSpec::Helpers</a></span> for all helper methods available in specs.</li>
<li>All items are reset to <span class='object_link'><a href="OpenHAB/Core/Types/UnDefType.html#NULL-constant" title="OpenHAB::Core::Types::UnDefType::NULL (constant)">NULL</a></span> before each spec.</li>
<li><code>on_load</code> triggers are <em>not</em> honored. Items will be reset to <span class='object_link'><a href="OpenHAB/Core/Types/UnDefType.html#NULL-constant" title="OpenHAB::Core::Types::UnDefType::NULL (constant)">NULL</a></span> before
the next spec anyway, so just don't waste the energy running them. You
can still trigger rules manually.</li>
<li>Rule triggers besides item related triggers (such as cron or watchers)
are not triggered. You can test them with <span class='object_link'><a href="OpenHAB/Core/Rules/Rule.html#trigger-instance_method" title="OpenHAB::Core::Rules::Rule#trigger (method)">trigger</a></span>.</li>
<li>You can trigger channels directly with <span class='object_link'>OpenHAB::RSpec::Helpers#trigger_channel</span>.</li>
<li>Timers aren't triggered automatically. Use the <span class='object_link'>OpenHAB::RSpec::Helpers#execute_timers</span>
helper to execute any timers that are ready to run. The <code>timecop</code> gem is
automatically included, so use <code>Timecop.travel(5.seconds)</code> (for example)
to travel forward in time and have timers ready to execute. Note that this
includes implicit timers created by rules that use the <code>for:</code> feature.</li>
<li>Logging levels can be changed in your code. Setting a log level for a logger
further up the chain (separated by dots) applies to all loggers underneath
it.</li>
</ul>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">Log</span>.logger(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.openhab.core.automation.internal.RuleEngineImpl</span><span style="color:#710">&quot;</span></span>).level = <span style="color:#A60">:debug</span>
<span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">Log</span>.gem_root.level = <span style="color:#A60">:debug</span>
<span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">Log</span>.root.level = <span style="color:#A60">:debug</span>
<span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">Log</span>.events.level = <span style="color:#A60">:info</span>
</code></pre>
<ul>
<li>Sometimes items are set to <code>autoupdate=&quot;false&quot;</code> in production to ensure the
devices responds, but you don't really care about the device in tests, you
just want to check if the effects of a rule happened. You can enable
autoupdating of all items by calling <span class='object_link'>OpenHAB::RSpec::Helpers#autoupdate_all_items</span>
from either your spec itself, or a <code>before</code> block.</li>
<li>Differing from when openHAB loads rules, all rules are loaded into a single
JRuby execution context, so changes to globals in one file will affect other
files. In particular, this applies to ids for reentrant timers will now share
a single namespace among all files.</li>
<li>Some actions may not be available; you should stub them out if you use them.
Core actions like <span class='object_link'>OpenHAB::Core::Actions#notify</span>, <span class='object_link'>OpenHAB::Core::Actions#say</span>,
and <span class='object_link'>OpenHAB::Core::Actions#play_sound</span> are stubbed to only log a message
(at debug level).</li>
<li>You may want to avoid rules from firing while setting up the proper state for
a test. In that case, use the <span class='object_link'>OpenHAB::RSpec::Helpers#suspend_rules</span> helper.</li>
<li>Item persistence is enabled by default using an in-memory store that only
tracks changes to items.</li>
<li>The <span class='object_link'>OpenHAB::RSpec::Helpers#install_addon</span> helper can be used to install an
addon like <code>binding-astro</code> if you need to be able to create things from your
rules. Note that the addon isn't actually allowed to start, just be installed to
make type metadata from XML available.</li>
</ul>
<h2>Configuration</h2>
<p>There are a few environment variables you can set to help the gem find the
necessary dependencies. The default should work for an OpenHABian install
or installation on Ubuntu or Debian with .debs. You may need to customize them
if your installation is laid out differently. Additional openHAB or Karaf
specific system properties will be set the same as openHAB would.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$OPENHAB_HOME</code></td>
<td><code>/usr/share/openhab</code></td>
<td>Location for the openHAB installation</td>
</tr>
<tr>
<td><code>$OPENHAB_RUNTIME</code></td>
<td><code>$OPENHAB_HOME/runtime</code></td>
<td>Location for openHAB's private Maven repository containing its JARs</td>
</tr>
</tbody>
</table>
<h2>Transformations</h2>
<p>Ruby transformations <em>must</em> have a magic comment <code># -*- mode: ruby -*-</code> in them to be loaded.
Then they can be accessed as a method on <span class='object_link'><a href="OpenHAB/Transform.html" title="OpenHAB::Transform (module)">OpenHAB::Transform</a></span> based on the filename:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">Transform</span>.compass(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">59 °</span><span style="color:#710">&quot;</span></span>)
<span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">Transform</span>.compass(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">30</span><span style="color:#710">&quot;</span></span>, <span style="color:#606">param</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">7</span><span style="color:#710">&quot;</span></span>)
<span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">Transform</span>::<span style="color:#036;font-weight:bold">Ruby</span>.compass(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">59 °</span><span style="color:#710">&quot;</span></span>)
</code></pre>
<p>They're loaded into a sub-JRuby engine, just like they run in openHAB.</p>
<h2>IRB</h2>
<p>If you would like to use a REPL sandbox to play with your items,
you can run <code>bundle console</code>. You may want to create an <code>.irbrc</code>
with the following contents to automatically boot things up:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># frozen_string_literal: true</span>

require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">rubygems</span><span style="color:#710">&quot;</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">bundler</span><span style="color:#710">&quot;</span></span>

<span style="color:#036;font-weight:bold">Bundler</span>.require(<span style="color:#A60">:default</span>, <span style="color:#A60">:development</span>, <span style="color:#A60">:test</span>)

require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openhab/rspec</span><span style="color:#710">&quot;</span></span>

launch_karaf
autorequires
set_up_autoupdates
load_rules
load_transforms
</code></pre>
</div></div>

      <div id="footer">
  Generated on Tue Dec  6 23:38:57 2022 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.28 (ruby-3.1.3).
</div>

    </div>
  </body>
</html>