<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: OpenHAB::RSpec::Helpers
  
    &mdash; Documentation by YARD 0.9.28
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "OpenHAB::RSpec::Helpers";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (H)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../OpenHAB.html" title="OpenHAB (module)">OpenHAB</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../RSpec.html" title="OpenHAB::RSpec (module)">RSpec</a></span></span>
     &raquo; 
    <span class="title">Helpers</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: OpenHAB::RSpec::Helpers
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/openhab/rspec/helpers.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Provides helper methods for use in specs, to easily work with and adjust
the openHAB environment.</p>
<p>These methods are automatically available in RSpec spec blocks, as well
as other per-spec hooks like <code>before</code> and <code>after</code>. You can also call them
explicitly.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2 id="Class Method Summary">
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#autorequires-class_method" title="autorequires (class method)">.<strong>autorequires</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Require all files configured to be autorequired with the jrubyscripting addon in openHAB.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#autoupdate_all_items-class_method" title="autoupdate_all_items (class method)">.<strong>autoupdate_all_items</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Reconfigure all items to autoupdate.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#execute_timers-class_method" title="execute_timers (class method)">.<strong>execute_timers</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Execute all pending timers.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#install_addon-class_method" title="install_addon (class method)">.<strong>install_addon</strong>(addon_id, wait: true, ready_markers: nil)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Install an openHAB addon.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#launch_karaf-class_method" title="launch_karaf (class method)">.<strong>launch_karaf</strong>(include_bindings: true, include_jsondb: true, private_confdir: false, use_root_instance: false)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Launch the karaf instance.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#load_rules-class_method" title="load_rules (class method)">.<strong>load_rules</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Load all Ruby rules in the config/automation directory.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#load_transforms-class_method" title="load_transforms (class method)">.<strong>load_transforms</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Load all Ruby transformations in the config/transform directory.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#log_file-class_method" title="log_file (class method)">.<strong>log_file</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The filename of the openHAB log.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#spec_log_lines-class_method" title="spec_log_lines (class method)">.<strong>spec_log_lines</strong>  &#x21d2; Array&lt;String&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The log lines since this spec started.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#suspend_rules-class_method" title="suspend_rules (class method)">.<strong>suspend_rules</strong>(&amp;block)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Suspend rules for the duration of the block.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#time_travel_and_execute_timers-class_method" title="time_travel_and_execute_timers (class method)">.<strong>time_travel_and_execute_timers</strong>(duration)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Wait <code>duration</code> seconds, then execute any pending timers.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#trigger_channel-class_method" title="trigger_channel (class method)">.<strong>trigger_channel</strong>(channel, event = &quot;&quot;)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Manually send an event to a trigger channel.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#wait-class_method" title="wait (class method)">.<strong>wait</strong>(how_long = 2.seconds) { ... } &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Calls the block repeatedly until the expectations inside pass.</p>
</div></span>
  
</li>

      
    </ul>
  




  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="autorequires-class_method">
  
    .<strong>autorequires</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Require all files configured to be autorequired with the jrubyscripting addon in openHAB.</p>
<p>This method is normally called by RSpec hooks.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 184</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">autorequires</span>
  <span style="color:#069">ENV</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">RUBYLIB</span><span style="color:#710">&quot;</span></span>] ||= <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>
  <span style="color:#069">ENV</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">RUBYLIB</span><span style="color:#710">&quot;</span></span>] += <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">:</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">unless</span> <span style="color:#069">ENV</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">RUBYLIB</span><span style="color:#710">&quot;</span></span>].empty?
  <span style="color:#069">ENV</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">RUBYLIB</span><span style="color:#710">&quot;</span></span>] += rubylib_dirs.join(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">:</span><span style="color:#710">&quot;</span></span>)

  <span style="color:#d70">$LOAD_PATH</span>.unshift(*<span style="color:#069">ENV</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">RUBYLIB</span><span style="color:#710">&quot;</span></span>]
    .split(<span style="color:#036;font-weight:bold">File</span>::<span style="color:#036;font-weight:bold">PATH_SEPARATOR</span>)
      .reject(&amp;<span style="color:#A60">:empty?</span>)
      .reject <span style="color:#080;font-weight:bold">do</span> |path|
                       <span style="color:#d70">$LOAD_PATH</span>.include?(path)
                     <span style="color:#080;font-weight:bold">end</span>)

  requires = jrubyscripting_config&amp;.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">require</span><span style="color:#710">&quot;</span></span>) || <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>
  requires.split(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,</span><span style="color:#710">&quot;</span></span>).each <span style="color:#080;font-weight:bold">do</span> |f|
    require f.strip
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="autoupdate_all_items-class_method">
  
    .<strong>autoupdate_all_items</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Reconfigure all items to autoupdate</p>
<p>To bypass any items configured to not autoupdate, waiting for the binding to update them.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 83</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">autoupdate_all_items</span>
  <span style="color:#080;font-weight:bold">if</span> instance_variable_defined?(<span style="color:#A60">:@autoupdated_items</span>)
    raise <span style="color:#036;font-weight:bold">RuntimeError</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">You should only call `autoupdate_all_items` once per spec</span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#33B">@autoupdated_items</span> = []
  <span style="color:#33B">@spec_metadata_provider</span> = <span style="color:#036;font-weight:bold">Core</span>::<span style="color:#036;font-weight:bold">Items</span>::<span style="color:#036;font-weight:bold">Metadata</span>::<span style="color:#036;font-weight:bold">Provider</span>.current

  <span style="color:#d70">$ir</span>.for_each <span style="color:#080;font-weight:bold">do</span> |_provider, item|
    <span style="color:#080;font-weight:bold">if</span> (hash = item.metadata[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">autoupdate</span><span style="color:#710">&quot;</span></span>])
      provider = <span style="color:#036;font-weight:bold">Core</span>::<span style="color:#036;font-weight:bold">Items</span>::<span style="color:#036;font-weight:bold">Metadata</span>::<span style="color:#036;font-weight:bold">Provider</span>.registry.provider_for(hash.uid)
      provider.remove(hash.uid)
      <span style="color:#33B">@autoupdated_items</span> &lt;&lt; [provider, hash]
      provider(<span style="color:#33B">@spec_metadata_provider</span>) <span style="color:#080;font-weight:bold">do</span>
        item.metadata[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">autoupdate</span><span style="color:#710">&quot;</span></span>] = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span>
      <span style="color:#080;font-weight:bold">end</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="execute_timers-class_method">
  
    .<strong>execute_timers</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Execute all pending timers</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


108
109
110
111
112
113
114
115</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 108</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">execute_timers</span>
  raise <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cannot execute timers when timers aren't mocked</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">unless</span> <span style="color:#069">self</span>.class.mock_timers?

  now = <span style="color:#036;font-weight:bold">ZonedDateTime</span>.now
  <span style="color:#036;font-weight:bold">DSL</span>::<span style="color:#036;font-weight:bold">TimerManager</span>.instance.instance_variable_get(<span style="color:#A60">:@timers</span>).each_key <span style="color:#080;font-weight:bold">do</span> |t|
    t.execute <span style="color:#080;font-weight:bold">if</span> t.active? &amp;&amp; t.execution_time &lt;= now
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="install_addon-class_method">
  
    .<strong>install_addon</strong>(addon_id, wait: true, ready_markers: nil)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Install an openHAB addon</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>addon_id</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The addon id, such as &quot;binding-mqtt&quot;</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>wait</span>
      
      
        <span class='type'>(<tt>true</tt>, <tt>false</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Wait until OSGi has confirmed the bundle is installed and running before returning.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>ready_markers</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;String&gt;</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Array of ready marker types to wait for.
The addon's bundle id is used as the identifier.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 322</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">install_addon</span>(addon_id, <span style="color:#606">wait</span>: <span style="color:#069">true</span>, <span style="color:#606">ready_markers</span>: <span style="color:#069">nil</span>)
  addon_service = <span style="color:#036;font-weight:bold">OSGi</span>.service(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.openhab.core.addon.AddonService</span><span style="color:#710">&quot;</span></span>)
  addon_service.install(addon_id)
  <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">unless</span> wait

  addon = <span style="color:#069">nil</span>
  loop <span style="color:#080;font-weight:bold">do</span>
    addon = addon_service.get_addon(addon_id, <span style="color:#069">nil</span>)
    <span style="color:#080;font-weight:bold">break</span> <span style="color:#080;font-weight:bold">if</span> addon.installed?

    sleep <span style="color:#60E">0.25</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">unless</span> ready_markers

  package_id = addon.logger_packages.first

  ready_markers = Array(ready_markers).map <span style="color:#080;font-weight:bold">do</span> |marker|
    <span style="color:#080;font-weight:bold">case</span> marker
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#036;font-weight:bold">String</span>
      org.openhab.core.service.ReadyMarker.new(marker, package_id)
    <span style="color:#080;font-weight:bold">else</span>
      marker
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  rs = <span style="color:#036;font-weight:bold">OSGi</span>.service(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.openhab.core.service.ReadyService</span><span style="color:#710">&quot;</span></span>)
  loop <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">break</span> <span style="color:#080;font-weight:bold">if</span> ready_markers.all? { |rm| rs.ready?(rm) }

    sleep <span style="color:#60E">0.25</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="launch_karaf-class_method">
  
    .<strong>launch_karaf</strong>(include_bindings: true, include_jsondb: true, private_confdir: false, use_root_instance: false)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Launch the karaf instance</p>
<p>This method is normally called by RSpec hooks.</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="Configuration.html" title="OpenHAB::RSpec::Configuration (module)">Configuration</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 210</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">launch_karaf</span>(<span style="color:#606">include_bindings</span>: <span style="color:#069">true</span>,
                 <span style="color:#606">include_jsondb</span>: <span style="color:#069">true</span>,
                 <span style="color:#606">private_confdir</span>: <span style="color:#069">false</span>,
                 <span style="color:#606">use_root_instance</span>: <span style="color:#069">false</span>)
  karaf = <span style="color:#036;font-weight:bold">Karaf</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span><span style="color:#036;font-weight:bold">Dir</span>.pwd<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">/.karaf</span><span style="color:#710">&quot;</span></span>)
  karaf.include_bindings = include_bindings
  karaf.include_jsondb = include_jsondb
  karaf.private_confdir = private_confdir
  karaf.use_root_instance = use_root_instance
  main = karaf.launch

  require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openhab/dsl</span><span style="color:#710">&quot;</span></span>

  require_relative <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">mocks/persistence_service</span><span style="color:#710">&quot;</span></span>
  require_relative <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">mocks/timer</span><span style="color:#710">&quot;</span></span>

  <span style="color:#777"># override several DSL methods</span>
  require_relative <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openhab/core/items/proxy</span><span style="color:#710">&quot;</span></span>
  require_relative <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openhab/core/things/proxy</span><span style="color:#710">&quot;</span></span>
  require_relative <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openhab/core/actions</span><span style="color:#710">&quot;</span></span>

  ps = <span style="color:#036;font-weight:bold">Mocks</span>::<span style="color:#036;font-weight:bold">PersistenceService</span>.instance
  bundle = org.osgi.framework.FrameworkUtil.get_bundle(org.openhab.core.persistence.PersistenceService)
  bundle.bundle_context.register_service(org.openhab.core.persistence.PersistenceService.java_class, ps, <span style="color:#069">nil</span>)

  <span style="color:#777"># wait for the rule engine</span>
  rs = <span style="color:#036;font-weight:bold">OSGi</span>.service(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.openhab.core.service.ReadyService</span><span style="color:#710">&quot;</span></span>)
  filter = org.openhab.core.service.ReadyMarkerFilter.new
              .with_type(org.openhab.core.service.StartLevelService::<span style="color:#036;font-weight:bold">STARTLEVEL_MARKER_TYPE</span>)
              .with_identifier(org.openhab.core.service.StartLevelService::<span style="color:#036;font-weight:bold">STARTLEVEL_RULEENGINE</span>.to_s)

  karaf.send(<span style="color:#A60">:wait</span>) <span style="color:#080;font-weight:bold">do</span> |continue|
    rs.register_tracker(org.openhab.core.service.ReadyService::<span style="color:#036;font-weight:bold">ReadyTracker</span>.impl { continue.call }, filter)
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#777"># RSpec additions</span>
  require_relative <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">suspend_rules</span><span style="color:#710">&quot;</span></span>

  <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">defined?</span>(::<span style="color:#036;font-weight:bold">RSpec</span>)
    ::<span style="color:#036;font-weight:bold">RSpec</span>.configure <span style="color:#080;font-weight:bold">do</span> |config|
      config.include <span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">DSL</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
  main
<span style="color:#080;font-weight:bold">rescue</span> <span style="color:#036;font-weight:bold">Exception</span> =&gt; e
  puts e.inspect
  puts e.backtrace
  raise
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="load_rules-class_method">
  
    .<strong>load_rules</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Load all Ruby rules in the config/automation directory</p>
<p>This method is normally called by RSpec hooks.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 267</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">load_rules</span>
  automation_path = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>org.openhab.core.OpenHAB.config_folder<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">/automation/ruby</span><span style="color:#710">&quot;</span></span>
  lib_dirs = rubylib_dirs.map { |d| <span style="color:#036;font-weight:bold">File</span>.join(d, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>) }
  lib_dirs &lt;&lt; <span style="color:#036;font-weight:bold">File</span>.join(gem_home, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>)

  <span style="color:#036;font-weight:bold">SuspendRules</span>.suspend_rules <span style="color:#080;font-weight:bold">do</span>
    files = <span style="color:#036;font-weight:bold">Dir</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>automation_path<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">/**/*.rb</span><span style="color:#710">&quot;</span></span>]
    files.reject! <span style="color:#080;font-weight:bold">do</span> |f|
      lib_dirs.any? { |l| f.start_with?(l) }
    <span style="color:#080;font-weight:bold">end</span>
    files.sort_by { |f| [get_start_level(f), f] }.each <span style="color:#080;font-weight:bold">do</span> |f|
      load f
    <span style="color:#080;font-weight:bold">rescue</span> <span style="color:#036;font-weight:bold">Exception</span> =&gt; e
      warn <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Failed loading </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>f<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>e.inspect<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>
      warn e.backtrace
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="load_transforms-class_method">
  
    .<strong>load_transforms</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Load all Ruby transformations in the config/transform directory</p>
<p>Since Ruby transformations must end with the .script extension, you must include
an Emacs modeline comment (<code># -*- mode: ruby -*-</code>) in your script for it to be
recognized.</p>
<p>This method is normally called by RSpec hooks.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


297
298
299
300
301
302
303
304
305
306
307
308
309
310
311</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 297</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">load_transforms</span>
  transform_path = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>org.openhab.core.OpenHAB.config_folder<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">/transform</span><span style="color:#710">&quot;</span></span>
  <span style="color:#036;font-weight:bold">Dir</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>transform_path<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">/**/*.script</span><span style="color:#710">&quot;</span></span>].each <span style="color:#080;font-weight:bold">do</span> |filename|
    script = <span style="color:#036;font-weight:bold">File</span>.read(filename)
    <span style="color:#080;font-weight:bold">next</span> <span style="color:#080;font-weight:bold">unless</span> ruby_file?(script)

    filename.slice!(<span style="color:#00D">0</span>..transform_path.length)
    dir = <span style="color:#036;font-weight:bold">File</span>.dirname(filename)
    modules = (dir == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">.</span><span style="color:#710">&quot;</span></span>) ? [] : moduleize(dir)
    basename = <span style="color:#036;font-weight:bold">File</span>.basename(filename)
    method = basename[<span style="color:#00D">0</span>...<span style="color:#00D">-7</span>]
    modules &lt;&lt; method
    <span style="color:#036;font-weight:bold">Transform</span>.add_script(modules, script)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="log_file-class_method">
  
    .<strong>log_file</strong>  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns The filename of the openHAB log.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The filename of the openHAB log.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


357
358
359</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 357</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">log_file</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>java.lang.System.get_property(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openhab.logdir</span><span style="color:#710">&quot;</span></span>, <span style="color:#069">nil</span>)<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">/openhab.log</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="spec_log_lines-class_method">
  
    .<strong>spec_log_lines</strong>  &#x21d2; <tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;String&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns The log lines since this spec started.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>it <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">logs</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  logger.trace(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">log line</span><span style="color:#710">&quot;</span></span>)
  expect(spec_log_lines).to include(match(<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">TRACE.*log line</span><span style="color:#404">/</span></span>))
<span style="color:#080;font-weight:bold">end</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span>&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The log lines since this spec started.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


370
371
372
373
374
375</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 370</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">spec_log_lines</span>
  <span style="color:#036;font-weight:bold">File</span>.open(log_file, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">rb</span><span style="color:#710">&quot;</span></span>) <span style="color:#080;font-weight:bold">do</span> |f|
    f.seek(<span style="color:#33B">@log_index</span>) <span style="color:#080;font-weight:bold">if</span> <span style="color:#33B">@log_index</span>
    f.read.split(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="suspend_rules-class_method">
  
    .<strong>suspend_rules</strong>(&amp;block)  &#x21d2; <tt><span class='object_link'>Object</span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Suspend rules for the duration of the block</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'>Object</span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The return value from the block.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


139
140
141</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 139</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">suspend_rules</span>(&amp;block)
  <span style="color:#036;font-weight:bold">SuspendRules</span>.suspend_rules(&amp;block)
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="time_travel_and_execute_timers-class_method">
  
    .<strong>time_travel_and_execute_timers</strong>(duration)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Wait <code>duration</code> seconds, then execute any pending timers</p>
<p>If timers are mocked, it will use Timecop. If they're not mocked, it
will just sleep for <code>duration</code></p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


125
126
127
128
129
130
131
132</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 125</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">time_travel_and_execute_timers</span>(duration)
  <span style="color:#080;font-weight:bold">if</span> <span style="color:#069">self</span>.class.mock_timers?
    <span style="color:#036;font-weight:bold">Timecop</span>.frozen? ? <span style="color:#036;font-weight:bold">Timecop</span>.freeze(duration) : <span style="color:#036;font-weight:bold">Timecop</span>.travel(duration)
    execute_timers
  <span style="color:#080;font-weight:bold">else</span>
    sleep duration
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="trigger_channel-class_method">
  
    .<strong>trigger_channel</strong>(channel, event = &quot;&quot;)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Manually send an event to a trigger channel</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>channel</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt><span class='object_link'><a href="../Core/Things/Channel.html" title="OpenHAB::Core::Things::Channel (class)">Core::Things::Channel</a></span></tt>, <tt><span class='object_link'><a href="../Core/Things/ChannelUID.html" title="OpenHAB::Core::Things::ChannelUID (class)">Core::Things::ChannelUID</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The channel to trigger.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>event</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The event data to send to the channel.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


170
171
172
173
174
175</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 170</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">trigger_channel</span>(channel, event = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>)
  channel = org.openhab.core.thing.ChannelUID.new(channel) <span style="color:#080;font-weight:bold">if</span> channel.is_a?(<span style="color:#036;font-weight:bold">String</span>)
  channel = channel.uid <span style="color:#080;font-weight:bold">if</span> channel.is_a?(org.openhab.core.thing.Channel)
  thing = channel.thing
  thing.handler.callback.channel_triggered(<span style="color:#069">nil</span>, channel, event)
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="wait-class_method">
  
    .<strong>wait</strong>(how_long = 2.seconds) { ... } &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Calls the block repeatedly until the expectations inside pass.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>how_long</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../CoreExt/Java/Duration.html" title="OpenHAB::CoreExt::Java::Duration (class)">Duration</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>2.seconds</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>how long to keep trying before giving up</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


149
150
151
152
153
154
155
156
157
158
159
160
161</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/openhab/rspec/helpers.rb', line 149</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">wait</span>(how_long = <span style="color:#00D">2</span>.seconds)
  start = <span style="color:#036;font-weight:bold">Process</span>.clock_gettime(<span style="color:#036;font-weight:bold">Process</span>::<span style="color:#036;font-weight:bold">CLOCK_MONOTONIC</span>)

  <span style="color:#080;font-weight:bold">begin</span>
    <span style="color:#080;font-weight:bold">yield</span>
  <span style="color:#080;font-weight:bold">rescue</span> ::<span style="color:#036;font-weight:bold">RSpec</span>::<span style="color:#036;font-weight:bold">Expectations</span>::<span style="color:#036;font-weight:bold">ExpectationNotMetError</span>,
         ::<span style="color:#036;font-weight:bold">RSpec</span>::<span style="color:#036;font-weight:bold">Mocks</span>::<span style="color:#036;font-weight:bold">MockExpectationError</span>
    raise <span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">Process</span>.clock_gettime(<span style="color:#036;font-weight:bold">Process</span>::<span style="color:#036;font-weight:bold">CLOCK_MONOTONIC</span>) &gt; start + how_long.to_f

    sleep <span style="color:#60E">0.1</span>
    <span style="color:#080;font-weight:bold">retry</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Wed Dec  7 15:28:43 2022 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.28 (ruby-3.1.3).
</div>

    </div>
  </body>
</html>