<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: USAGE
  
    &mdash; Documentation by YARD 0.9.28
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "USAGE";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: USAGE</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h1 id="jruby-scripting">JRuby Scripting</h1>
<p>This add-on provides <a href="https://www.jruby.org/">JRuby</a> scripting language for automation rules.
Also included is <a href="https://ccutrer.github.io/openhab-jrubyscripting/">openhab-jrubyscripting</a>, a fairly high-level Ruby gem to support automation in openHAB.
It provides native Ruby access to common openHAB functionality within rules including items, things, actions, logging and more.
If you're new to Ruby, you may want to check out <a href="file.ruby-basics.html">Ruby Basics</a>.</p>
<ul>
<li><a href="#why-ruby">Why Ruby?</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#usage">Usage</a>
<ul>
<li><a href="#ui-based-scripts">UI Based Scripts</a></li>
<li><a href="#file-based-scripts">File Based Scripts</a></li>
<li><a href="#event-object">Event Object</a></li>
</ul>
</li>
<li><a href="#library-details">Library Details</a>
<ul>
<li><a href="#items">Items</a>
<ul>
<li><a href="#groups">Groups</a></li>
<li><a href="#commands">Commands</a></li>
<li><a href="#updates">Updates</a></li>
<li><a href="#state">State</a></li>
<li><a href="#metadata">Metadata</a></li>
<li><a href="#persistence">Persistence</a></li>
<li><a href="#semantic-model">Semantic Model</a></li>
<li><a href="#linked-things">Linked Things</a></li>
<li><a href="#item-builder">Item Builder</a></li>
</ul>
</li>
<li><a href="#things">Things</a></li>
<li><a href="#actions">Actions</a></li>
<li><a href="#logging">Logging</a></li>
<li><a href="#timers">Timers</a></li>
<li><a href="#cache">Cache</a></li>
<li><a href="#time">Time</a></li>
<li><a href="#gems">Gems</a></li>
<li><a href="#shared-code">Shared Code</a></li>
</ul>
</li>
<li><a href="#file-based-rules">File Based Rules</a>
<ul>
<li><a href="#basic-rule-structure">Basic Rule Structure</a></li>
<li><a href="#rule-triggers">Rule Triggers</a>
<ul>
<li><a href="#item-or-thing-changed">Item or Thing Changed</a></li>
<li><a href="#item-updated">Item Updated</a></li>
<li><a href="#item-received-a-command">Item Received a Command</a></li>
<li><a href="#member-of-group-trigger">Member-of-Group Trigger</a></li>
<li><a href="#script-is-loaded">Script is Loaded</a></li>
<li><a href="#openhab-system-started">openHAB System Started</a></li>
<li><a href="#cron-trigger">Cron Trigger</a></li>
<li><a href="#other-triggers">Other Triggers</a></li>
<li><a href="#combining-multiple-triggers">Combining Multiple Triggers</a></li>
<li><a href="#combining-multiple-conditions">Combining Multiple Conditions</a></li>
</ul>
</li>
<li><a href="#rule-conditions">Rule Conditions</a></li>
<li><a href="#rule-executions">Rule Executions</a>
<ul>
<li><a href="#run-execution-block">Run Execution Block</a></li>
<li><a href="#triggered-execution-block">Triggered Execution Block</a></li>
<li><a href="#delay-execution-block">Delay Execution Block</a></li>
</ul>
</li>
<li><a href="#terse-rules">Terse Rules</a></li>
<li><a href="#rule-manipulations">Rule Manipulations</a></li>
<li><a href="#early-exit-from-a-rule">Early Exit From a Rule</a></li>
<li><a href="#dynamic-generation-of-rules">Dynamic Generation of Rules</a></li>
<li><a href="#hooks">Hooks</a></li>
<li><a href="#transformations">Transformations</a></li>
</ul>
</li>
<li><a href="#calling-java-from-jruby">Calling Java From JRuby</a></li>
</ul>
<p>Additional <a href="file.examples.html">example rules are available</a>, as well as examples of <a href="file.conversions.html">conversions from DSL and Python rules</a>.</p>
<h2 id="why-ruby-">Why Ruby?</h2>
<ul>
<li>Ruby is designed for programmers' productivity with the idea that programming should be fun for programmers.</li>
<li>Ruby emphasizes the necessity for software to be understood by humans first and computers second.</li>
<li>For me, automation is a hobby, I want to enjoy writing automation not fight compilers and interpreters .</li>
<li>Rich ecosystem of tools, including things like Rubocop to help developers write clean code and RSpec to test the libraries.</li>
<li>Ruby is really good at letting one express intent and creating a DSL within Ruby to make that expression easier.</li>
</ul>
<h3>Design points <!-- raw HTML omitted --></h3>
<ul>
<li>Create an intuitive method of defining rules and automation
<ul>
<li>Rule language should &quot;flow&quot; in a way that you can read the rules out loud</li>
</ul>
</li>
<li>Abstract away complexities of openHAB</li>
<li>Enable all the power of Ruby and openHAB</li>
<li>Create a Frictionless experience for building automation</li>
<li>The common, yet tricky tasks are abstracted and made easy. e.g. creating a timer that automatically reschedules itself.</li>
<li>Tested
<ul>
<li>Designed and tested using <a href="https://en.wikipedia.org/wiki/Test-driven_development">Test-Driven Development</a> with <a href="https://rspec.info/">RSpec</a></li>
</ul>
</li>
<li>Extensible.
<ul>
<li>Anyone should be able to customize and add/remove core language features</li>
</ul>
</li>
<li>Easy access to the Ruby ecosystem in rules through Ruby gems.</li>
</ul>
<h2 id="installation">Installation</h2>
<h3>Prerequisites <!-- raw HTML omitted --></h3>
<ol>
<li>openHAB 3.3+</li>
<li>The JRuby Scripting Language Addon</li>
</ol>
<h3>From the User Interface <!-- raw HTML omitted --></h3>
<ol>
<li>Go to <code>Settings -&gt; Add-ons -&gt; Automation</code> and install the jrubyscripting automation addon following the <a href="https://www.openhab.org/docs/configuration/addons.html">openHAB instructions</a></li>
<li>Go to <code>Settings -&gt; Other Services -&gt; JRuby Scripting</code>:
<ul>
<li><strong>Ruby Gems</strong>: <code>openhab-jrubyscripting=~&gt;5.0</code></li>
<li><strong>Require Scripts</strong>: <code>openhab/dsl</code> (not required, but recommended)</li>
</ul>
</li>
</ol>
<h3>Using Files <!-- raw HTML omitted --></h3>
<ol>
<li>
<p>Edit <code>&lt;OPENHAB_CONF&gt;/services/addons.cfg</code> and ensure that <code>jrubyscripting</code> is included in an uncommented <code>automation=</code> list of automations to install.</p>
</li>
<li>
<p>Optionally configure JRuby openHAB services</p>
<p>Create a file called <code>jruby.cfg</code> in <code>&lt;OPENHAB_CONF&gt;/services/</code> with the following content:</p>
<pre class="code ruby"><code class="ruby">org.openhab.automation.jrubyscripting<span style="color:#A60">:gems=</span>openhab-jrubyscripting=~&gt;<span style="color:#60E">5.0</span>
org.openhab.automation.jrubyscripting<span style="color:#A60">:require=</span>openhab/dsl
</code></pre>
<p>This configuration with the openhab-jrubyscripting gem specified with <a href="https://thoughtbot.com/blog/rubys-pessimistic-operator">pessimistic versioning</a> will install any version of openhab-jrubyscripting greater than or equal to 5.0 but less than 6.0.
On system restart if any (non-breaking) new versions of the library are available they will automatically be installed.</p>
</li>
</ol>
<h3>Upgrading <!-- raw HTML omitted --></h3>
<p>Depending on the versioning selected in the <code>jruby.cfg</code> or the gems list in the user interface, upgrading will either be automatic after an openHAB restart or manual.
For manual upgrades select the exact version of the gem. For example, <code>org.openhab.automation.jrubyscripting:gems=openhab-jrubyscripting=5.0.0</code> will install and stay at version 5.0.0.
To upgrade to version 5.0.1, change the configuration to <code>org.openhab.automation.jrubyscripting:gems=openhab-jrubyscripting=5.0.1</code>.
To automatically upgrade the gem, it is recommended to use pessimistic versioning: <code>org.openhab.automation.jrubyscripting:gems=openhab-jrubyscripting=~&gt;5.0</code>.
This will install at least version 5.0 and on every restart automatically install any version that is less than 6.0.
This ensures that fixes and new features are available without introducing any breaking changes.</p>
<h2 id="configuration">Configuration</h2>
<p>After installing this add-on, you will find configuration options in the openHAB portal under <em>Settings -&gt; Other Services -&gt; JRuby Scripting</em>.
Alternatively, JRuby configuration parameters may be set by creating a <code>jruby.cfg</code> file in <code>conf/services/</code>.</p>
<p>By default this add-on includes the <a href="https://github.com/ccutrer/openhab-jrubyscripting/">openhab-jrubyscripting</a> Ruby gem and automatically <code>require</code>s it.
This allows the use of <span class='object_link'><a href="OpenHAB/DSL.html#items-class_method" title="OpenHAB::DSL.items (method)">items</a></span>, <span class='object_link'><a href="OpenHAB/DSL.html#rules-class_method" title="OpenHAB::DSL.rules (method)">rules</a></span>, <span class='object_link'><a href="OpenHAB/DSL.html#shared_cache-class_method" title="OpenHAB::DSL.shared_cache (method)">shared_cache</a></span> and other objects in your scripts.
This functionality can be disabled for users who prefer to manage their own gems and <code>require</code>s via the add-on configuration options.
Simply change the <code>gems</code> and <code>require</code> configuration settings.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gem_home</code></td>
<td>The path to store Ruby Gems. <!-- raw HTML omitted --><!-- raw HTML omitted -->Default: <code>$OPENHAB_CONF/automation/ruby/.gem/{RUBY_ENGINE_VERSION}</code></td>
</tr>
<tr>
<td><code>gems</code></td>
<td>A list of gems to install on start up or settings change. <!-- raw HTML omitted --><!-- raw HTML omitted -->Default: <code>openhab-jrubyscripting=~&gt;5.0.0</code></td>
</tr>
<tr>
<td><code>check_update</code></td>
<td>Check for updated version of <code>gems</code> on start up or settings change. <!-- raw HTML omitted --><!-- raw HTML omitted -->Default: <code>true</code></td>
</tr>
<tr>
<td><code>require</code></td>
<td>List of scripts to be required automatically. <!-- raw HTML omitted --><!-- raw HTML omitted -->Default: <code>openhab/dsl</code></td>
</tr>
<tr>
<td><code>rubylib</code></td>
<td>Search path for user libraries. <!-- raw HTML omitted --><!-- raw HTML omitted -->Default: <code>$OPENHAB_CONF/automation/ruby/lib</code></td>
</tr>
<tr>
<td><code>local_context</code></td>
<td>See notes below. <!-- raw HTML omitted --><!-- raw HTML omitted -->Default: <code>singlethread</code></td>
</tr>
<tr>
<td><code>local_variables</code></td>
<td>See notes below. <!-- raw HTML omitted --><!-- raw HTML omitted -->Default: <code>transient</code></td>
</tr>
</tbody>
</table>
<p>When using file-based configuration, these parameters must be prefixed with <code>org.openhab.automation.jrubyscripting:</code>, for example:</p>
<pre class="code text"><code class="text">org.openhab.automation.jrubyscripting:gems=openhab-jrubyscripting=~&gt;5.0
org.openhab.automation.jrubyscripting:require=openhab/dsl
</code></pre>
<h3>gem_home <!-- raw HTML omitted --></h3>
<p>Path to where Ruby Gems will be installed to and loaded from. The directory will be created if necessary.
You can use <code>{RUBY_ENGINE_VERSION}</code>, <code>{RUBY_ENGINE}</code> and/or <code>{RUBY_VERSION}</code> replacements in this value
to automatically point to a new directory when the addon is updated with a new version of JRuby.</p>
<h3>gems <!-- raw HTML omitted --></h3>
<p>A comma separated list of <a href="https://rubygems.org/">Ruby Gems</a> to install.
The default installs the version of the helper for this version of openHAB.</p>
<p>Multiple version specifiers can be added by separating them with a semicolon.</p>
<p>Example with multiple version specifiers:</p>
<pre class="code text"><code class="text">org.openhab.automation.jrubyscripting:gems=library= &gt;= 2.2.0; &lt; 3.0, another-gem= &gt; 4.0.0.a; &lt; 5
</code></pre>
<h3>check_update <!-- raw HTML omitted --></h3>
<p>Check RubyGems for updates to the above gems when openHAB starts or JRuby settings are changed.
Otherwise it will try to fulfil the requirements with locally installed gems, and you can manage them yourself
with an external Ruby by setting the same GEM_HOME.</p>
<h3>require <!-- raw HTML omitted --></h3>
<p>A comma separated list of script names to be required by the JRuby Scripting Engine at the beginning of user scripts.
The default is to require the helper library.</p>
<h3>rubylib <!-- raw HTML omitted --></h3>
<p>Search path for user libraries. Separate each path with a colon (semicolon in Windows).</p>
<h3>local_context <!-- raw HTML omitted --></h3>
<p>The local context holds Ruby runtime, name-value pairs for sharing variables between Java and Ruby.
Valid values are: <code>singleton</code>, <code>threadsafe</code>, <code>singlethread</code>, or <code>concurrent</code>.
See <a href="https://github.com/jruby/jruby/wiki/RedBridge#Context_Instance_Type">this</a> for options and details.</p>
<h3>local_variables <!-- raw HTML omitted --></h3>
<p>Defines how variables are shared between Ruby and Java. Valid values are: <code>transient</code>, <code>persistent</code>, or <code>global</code>.
See the <a href="https://github.com/jruby/jruby/wiki/RedBridge#local-variable-behavior-options">JRuby documentation</a> for options and details.</p>
<h2 id="usage">Usage</h2>
<h3 id="ui-based-scripts">UI Based Scripts</h3>
<p>The quickest way to add rules is through the openHAB Web UI.</p>
<p>Advanced users, or users migrating scripts from existing systems may want to use
<a href="#file-based-scripts">File Based Scripts</a> for managing rules using files in the user configuration directory.</p>
<h4>Adding Triggers <!-- raw HTML omitted --></h4>
<p>Using the openHAB UI, first create a new rule and set a trigger condition.</p>
<p><img src="docs/images/rule-config.png" alt="openHAB Rule Configuration" /></p>
<h4>Adding Actions <!-- raw HTML omitted --></h4>
<p>Select &quot;Add Action&quot; and then select &quot;Run Script&quot; with &quot;Ruby&quot;.
This will bring up an empty script editor where you can enter your JavaScript.</p>
<p><img src="docs/images/rule-engines.png" alt="openHAB Rule Engines" /></p>
<p>You can now write rules using standard Ruby along with the included openHAB <a href="#library-details">library</a>.</p>
<p><img src="docs/images/rule-script.png" alt="openHAB Rule Script" /></p>
<p>For example, turning a light on:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">KitchenLight</span>.on
logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Kitchen Light State: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span><span style="color:#036;font-weight:bold">KitchenLight</span>.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)
</code></pre>
<p>Sending a notification:</p>
<pre class="code ruby"><code class="ruby">notify(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">romeo@montague.org</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Balcony door is open</span><span style="color:#710">&quot;</span></span>)
</code></pre>
<p>Querying the status of a thing:</p>
<pre class="code ruby"><code class="ruby">logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Thing status: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">zwave:serial_zstick:512</span><span style="color:#710">&quot;</span></span>].status<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
</span></span></code></pre>
<p>Theoretically you could even use a system start trigger with a UI rule, and then use the <a href="#rules">syntax</a> mostly developed for file based rules to create multiple rules.</p>
<h3 id="file-based-scripts">File Based Scripts</h3>
<p>The JRuby Scripting addon will load scripts from <code>automation/ruby</code> in the user configuration directory.
The system will automatically reload scripts when changes are detected to files.
Local variable state is not persisted among reloads, see using the <a href="#cache">cache</a> for a convenient way to persist objects.
See <a href="#rules">Rules</a> for examples of creating rules withing your scripts.</p>
<h3 id="event-object">Event Object</h3>
<p>When you use &quot;Item event&quot; as trigger (i.e. &quot;[item] received a command&quot;, &quot;[item] was updated&quot;, &quot;[item] changed&quot;), there is additional context available for the action in a variable called <code>event</code>.</p>
<p>This tables gives an overview of the <code>event</code> object for most common trigger types. For full details, explore <span class='object_link'><a href="OpenHAB/Core/Events.html" title="OpenHAB::Core::Events (module)">OpenHAB::Core::Events</a></span>.</p>
<table>
<thead>
<tr>
<th>Property Name</th>
<th>Type</th>
<th>Trigger Types</th>
<th>Description</th>
<th>Rules DSL Equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>state</code></td>
<td><span class='object_link'><a href="OpenHAB/Core/Types/State.html" title="OpenHAB::Core::Types::State (module)">State</a></span> or <code>nil</code></td>
<td><code>[item] changed</code>, <code>[item] was updated</code></td>
<td>State that triggered event</td>
<td><code>triggeringItem.state</code></td>
</tr>
<tr>
<td><code>was</code></td>
<td><span class='object_link'><a href="OpenHAB/Core/Types/State.html" title="OpenHAB::Core::Types::State (module)">State</a></span> or <code>nil</code></td>
<td><code>[item] changed</code></td>
<td>Previous state of Item or Group that triggered event</td>
<td><code>previousState</code></td>
</tr>
<tr>
<td><code>command</code></td>
<td><span class='object_link'><a href="OpenHAB/Core/Types/Command.html" title="OpenHAB::Core::Types::Command (module)">Command</a></span></td>
<td><code>[item] received a command</code></td>
<td>Command that triggered event</td>
<td><code>receivedCommand</code></td>
</tr>
<tr>
<td><code>item</code></td>
<td><span class='object_link'><a href="OpenHAB/Core/Items/Item.html" title="OpenHAB::Core::Items::Item (module)">Item</a></span></td>
<td>all</td>
<td>Item that triggered event</td>
<td><code>triggeringItem</code></td>
</tr>
</tbody>
</table>
<pre class="code ruby"><code class="ruby">logger.info(event.state == <span style="color:#036;font-weight:bold">ON</span>)
</code></pre>
<pre class="code ruby"><code class="ruby">event.item
</code></pre>
<p>Get the Triggering Item's Name:</p>
<pre class="code ruby"><code class="ruby">event.item.name
</code></pre>
<p>Get the Triggering Item's Label:</p>
<pre class="code ruby"><code class="ruby">event.item.label
</code></pre>
<p>Get the Triggering Item's State:</p>
<pre class="code ruby"><code class="ruby">event.state <span style="color:#777"># this version retrieves the item's state when the event was generated</span>
</code></pre>
<p>or</p>
<pre class="code ruby"><code class="ruby">event.item.state <span style="color:#777"># this version will re-query the item for its state</span>
</code></pre>
<pre class="code ruby"><code class="ruby"><span style="color:#080;font-weight:bold">if</span> event.item.state == <span style="color:#036;font-weight:bold">ON</span>
  <span style="color:#777"># do something</span>
<span style="color:#080;font-weight:bold">end</span>
<span style="color:#777"># or (preferable)</span>
<span style="color:#080;font-weight:bold">if</span> event.item.on?
  <span style="color:#777"># do something</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Get the Triggering Item's Previous State:</p>
<pre class="code ruby"><code class="ruby">event.was
</code></pre>
<pre class="code ruby"><code class="ruby"><span style="color:#080;font-weight:bold">if</span> event.was.on?
  <span style="color:#777"># do something</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Compare Triggering Item's State Against Previous State:</p>
<pre class="code ruby"><code class="ruby">event.state &gt; event.was
</code></pre>
<p>Get the Received Command:</p>
<pre class="code ruby"><code class="ruby">event.command
</code></pre>
<pre class="code ruby"><code class="ruby"><span style="color:#080;font-weight:bold">if</span> event.command.on?
  <span style="color:#777"># do something</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h2 id="library-details">Library Details</h2>
<p>The openHAB JRuby Scripting runtime attempts to provide a familiar environment to Ruby developers.</p>
<h3 id="items">Items</h3>
<p>The <span class='object_link'><a href="OpenHAB/DSL.html#items-class_method" title="OpenHAB::DSL.items (method)">items</a></span> object allows interactions with openHAB items.
However, most items can be referred to directly by name:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">My_Item</span>
gWindowBlinds
</code></pre>
<p>Items can be retrieved dynamically:</p>
<pre class="code ruby"><code class="ruby">the_item = items[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">My_Item</span><span style="color:#710">'</span></span>] <span style="color:#777"># This returns an Item object, not just its state</span>
<span style="color:#777"># For all intents and purposes, the_item variable is the same as My_Item in the previous example</span>
</code></pre>
<p>Get the Item's Name as a String:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">My_Item</span>.name
</code></pre>
<p>Get the Item's Label:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">My_Item</span>.label
</code></pre>
<p>Get a Related Item:</p>
<pre class="code ruby"><code class="ruby">my_light_item = items[<span style="color:#036;font-weight:bold">My_Switch</span>.name.sub(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">_Switch</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">_Light</span><span style="color:#710">'</span></span>)]
</code></pre>
<h4 id="groups">Groups</h4>
<p>Groups are regular items, but can also contain other items.</p>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># direct members</span>
gTest.members

<span style="color:#777"># direct members and all their descendents</span>
gTest.all_members
</code></pre>
<p>Group members work like a <a href="https://ruby-doc.org/core-2.6/Array.html">Ruby array</a>
so you can use <code>&amp;</code> for intersection, <code>|</code> for union, and <code>-</code> for difference.</p>
<pre class="code ruby"><code class="ruby">curtains_in_family_room = gFamilyRoom.members &amp; gCurtains.members
</code></pre>
<p>You can iterate over group members with Ruby's ubiquitous <code>#each</code> method:</p>
<pre class="code ruby"><code class="ruby">gTest.members.each <span style="color:#080;font-weight:bold">do</span> |item|
  <span style="color:#777"># process item</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># Iterate over all members, including members of members</span>
gTest.all_members.each <span style="color:#080;font-weight:bold">do</span> |item|
  <span style="color:#777"># process item</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Group members are also <a href="https://ruby-doc.org/core-3.1.2/Enumerable.html">Enumerable</a>, so can use any of tthose included methods:</p>
<pre class="code ruby"><code class="ruby">members_that_are_on = gTest.members.select(&amp;<span style="color:#A60">:on?</span>)

<span style="color:#777"># exclude state</span>
members_that_are_not_on = gTest.members.reject(&amp;<span style="color:#A60">:on?</span>)

<span style="color:#777"># Filter with code:</span>
high_temperatures = gTemperatures.members.select(&amp;<span style="color:#A60">:state?</span>).select { |item| item.state &gt; <span style="color:#00D">30</span> | <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">°C</span><span style="color:#710">'</span></span> }
</code></pre>
<p>See also <a href="https://ruby-doc.org/core-2.6/Array.html#class-Array-label-Accessing+Elements">Accessing elements in a Ruby array</a>.</p>
<p>Get a sorted list of Group members matching a condition:</p>
<pre class="code ruby"><code class="ruby">sorted_items_by_battery_level = gBattery.members
                                        .select(&amp;<span style="color:#A60">:state?</span>) <span style="color:#777"># only include non NULL / UNDEF members</span>
                                        .select { |item| item.state &lt; <span style="color:#00D">20</span> } <span style="color:#777"># select only those with low battery</span>
                                        .sort_by(&amp;<span style="color:#A60">:state</span>) 
</code></pre>
<p>Get a list of values mapped from the members of a group:</p>
<pre class="code ruby"><code class="ruby">battery_levels = gBattery.select(&amp;<span style="color:#A60">:state?</span>) <span style="color:#777"># only include non NULL / UNDEF members</span>
                         .sort_by(&amp;<span style="color:#A60">:state</span>)
                         .map { |item| <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>item.label<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>item.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span> } <span style="color:#777"># Use item state default formatting</span>
</code></pre>
<p>Perform arithmetic on values from members of a group:</p>
<pre class="code ruby"><code class="ruby">weekly_rainfall = gRainWeeklyForecast.members.sum(&amp;<span style="color:#A60">:state</span>)
</code></pre>
<h4 id="commands">Commands</h4>
<p>These three variants do the same thing:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">My_Item</span>.on
<span style="color:#036;font-weight:bold">My_Item</span>.command <span style="color:#036;font-weight:bold">ON</span>
<span style="color:#036;font-weight:bold">My_Item</span> &lt;&lt; <span style="color:#036;font-weight:bold">ON</span>
</code></pre>
<p>Note: all possible commands are supported on the corresponding item types, e.g. <code>on</code>, <code>off</code>, <code>up</code>, <code>down</code>, <code>play</code>, <code>pause</code>, <code>stop</code>, etc.
For more details, see the individual item classes under <span class='object_link'><a href="OpenHAB/Core/Items.html" title="OpenHAB::Core::Items (module)">OpenHAB::Core::Items</a></span>.</p>
<h5>Sending Commands to an Item Only When Its State is Different <!-- raw HTML omitted --></h5>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">My_Item</span>.ensure.on
<span style="color:#036;font-weight:bold">My_Item</span>.ensure.command <span style="color:#036;font-weight:bold">ON</span>
<span style="color:#036;font-weight:bold">My_Item</span>.ensure &lt;&lt; <span style="color:#036;font-weight:bold">ON</span>

<span style="color:#777"># ensure causes the command to return nil if the item is already in the same state</span>
logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Turning off the light</span><span style="color:#710">&quot;</span></span>) <span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">My_Item</span>.ensure.off
</code></pre>
<h5>Timed Commands <!-- raw HTML omitted --></h5>
<p>A <span class='object_link'><a href="OpenHAB/DSL/Items/TimedCommand.html" title="OpenHAB::DSL::Items::TimedCommand (module)">Timed Command</a></span> is similar to the openHAB Item's <a href="https://www.openhab.org/docs/configuration/items.html#parameter-expire">expire parameter</a> but it offers more flexibility.
It removes the need to manually create a timer.
The command is sent to the item, then after the duration has elapsed, reverted.
It also handles automatically canceling the timer if the item changes states before it reverts.</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">My_Switch</span>.on <span style="color:#606">for</span>: <span style="color:#00D">5</span>.minutes
</code></pre>
<h4 id="updates">Updates</h4>
<p>Post an update to an item:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">My_Switch</span>.update <span style="color:#036;font-weight:bold">ON</span>
</code></pre>
<h4 id="state">State</h4>
<p>The Item's state is accessible through <span class='object_link'><a href="OpenHAB/Core/Items/GenericItem.html#state-instance_method" title="OpenHAB::Core::Items::GenericItem#state (method)">Item#state</a></span>:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">My_Item</span>.state == <span style="color:#036;font-weight:bold">ON</span>
  <span style="color:#777"># do something</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># This syntax is equivalent and preferred:</span>
<span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">My_Item</span>.on?
  <span style="color:#777"># do something</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">Indoor_Temperature</span>.state &gt; <span style="color:#00D">20</span> | <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">°C</span><span style="color:#710">'</span></span> || <span style="color:#036;font-weight:bold">Indoor_Temperature</span>.state &gt; <span style="color:#036;font-weight:bold">Outdoor_Temperature</span>.state
  <span style="color:#777"># do something</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Note: Boolean helper methods are available depending on the item / state type.
For example <code>up?</code>, <code>down?</code>, <code>closed?</code>, <code>open?</code>, etc.</p>
<p>Check if an Item's state is <span class='object_link'><a href="OpenHAB/Core/Types/UnDefType.html#NULL-constant" title="OpenHAB::Core::Types::UnDefType::NULL (constant)">NULL</a></span> of <span class='object_link'><a href="OpenHAB/Core/Types/UnDefType.html#UNDEF-constant" title="OpenHAB::Core::Types::UnDefType::UNDEF (constant)">UNDEF</a></span>:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">My_Item</span>.state?
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">My_Item is not NULL nor UNDEF</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h5>Compare Item's State <!-- raw HTML omitted --></h5>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">String_Item</span>.state == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test string</span><span style="color:#710">'</span></span>
<span style="color:#036;font-weight:bold">Number_Item</span>.state &gt; <span style="color:#60E">5.3</span>
items[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Number_Item</span><span style="color:#710">'</span></span>].state == <span style="color:#00D">10</span>

<span style="color:#777"># Compare Quantity Types</span>
<span style="color:#036;font-weight:bold">Temperature_Item</span>.state &gt; <span style="color:#00D">24</span> | <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">°C</span><span style="color:#710">'</span></span>
<span style="color:#036;font-weight:bold">Indoor_Temperature</span>.state &gt; <span style="color:#036;font-weight:bold">Outdoor_Temperature</span>.state 
<span style="color:#036;font-weight:bold">Indoor_Temperature</span>.state &gt; <span style="color:#036;font-weight:bold">Outdoor_Temperature</span>.state + <span style="color:#00D">5</span> | <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">°C</span><span style="color:#710">'</span></span>
<span style="color:#036;font-weight:bold">Indoor_Temperature</span>.state - <span style="color:#036;font-weight:bold">Outdoor_Temperature</span>.state &gt; <span style="color:#00D">5</span> | <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">°C</span><span style="color:#710">'</span></span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL.html#unit-class_method" title="OpenHAB::DSL.unit (method)">unit block</a></span></p>
<h5>Loose Type Comparisons <!-- raw HTML omitted --></h5>
<p>Some openHAB item types can accept different command types.
For example, a <span class='object_link'><a href="OpenHAB/Core/Items/DimmerItem.html" title="OpenHAB::Core::Items::DimmerItem (class)">DimmerItem</a></span> can accept a command with an <span class='object_link'><a href="OpenHAB/Core/Types/OnOffType.html" title="OpenHAB::Core::Types::OnOffType (class)">OnOffType</a></span>, <span class='object_link'><a href="OpenHAB/Core/Types/IncreaseDecreaseType.html" title="OpenHAB::Core::Types::IncreaseDecreaseType (class)">IncreaseDecreaseType</a></span> or a <span class='object_link'><a href="OpenHAB/Core/Types/PercentType.html" title="OpenHAB::Core::Types::PercentType (class)">PercentType</a></span>.
However, ultimately an item only stores its state in its native type, e.g. a <span class='object_link'><a href="OpenHAB/Core/Items/DimmerItem.html" title="OpenHAB::Core::Items::DimmerItem (class)">DimmerItems</a></span>'s native type is <span class='object_link'><a href="OpenHAB/Core/Types/PercentType.html" title="OpenHAB::Core::Types::PercentType (class)">PercentType</a></span>.</p>
<p>Comparisons between two compatible types will return true when applicable, for example:</p>
<ul>
<li><code>0</code> (<span class='object_link'><a href="OpenHAB/Core/Types/PercentType.html" title="OpenHAB::Core::Types::PercentType (class)">PercentType</a></span>) equals <span class='object_link'><a href="OpenHAB/Core/Types/OnOffType.html#OFF-constant" title="OpenHAB::Core::Types::OnOffType::OFF (constant)">OFF</a></span> and the <code>off?</code> predicate will return true</li>
<li>A positive <span class='object_link'><a href="OpenHAB/Core/Types/PercentType.html" title="OpenHAB::Core::Types::PercentType (class)">PercentType</a></span> equals <span class='object_link'><a href="OpenHAB/Core/Types/OnOffType.html#ON-constant" title="OpenHAB::Core::Types::OnOffType::ON (constant)">ON</a></span> and the <code>on?</code> predicate will return true</li>
</ul>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">DimmerItem1</span>.update(<span style="color:#00D">10</span>)
sleep <span style="color:#00D">1</span>
<span style="color:#036;font-weight:bold">DimmerItem1</span>.state == <span style="color:#00D">10</span> <span style="color:#777"># =&gt; true</span>
<span style="color:#036;font-weight:bold">DimmerItem1</span>.state == <span style="color:#036;font-weight:bold">ON</span> <span style="color:#777"># =&gt; true</span>
<span style="color:#036;font-weight:bold">DimmerItem1</span>.on? <span style="color:#777"># =&gt; true</span>
<span style="color:#036;font-weight:bold">DimmerItem1</span>.off? <span style="color:#777"># =&gt; false</span>
</code></pre>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">command</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  received_command <span style="color:#036;font-weight:bold">DimmerItem1</span>
  run <span style="color:#080;font-weight:bold">do</span> |event|
    <span style="color:#080;font-weight:bold">if</span> event.command.on?
      <span style="color:#777"># This will be executed even when the command is a positive PercentType</span>
      <span style="color:#777"># instead of an actual ON command</span>
      logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">DimmerItem1 is being turned on</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">DimmerItem1</span> &lt;&lt; <span style="color:#00D">100</span> <span style="color:#777"># =&gt; This will trigger the logger.info above</span>
</code></pre>
<h5>Bypassing Loose Type-Comparisons <!-- raw HTML omitted --></h5>
<p>If at any point you want to bypass loose type conversions, use <code>eql?</code>.</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">DimmerItem1</span>.update(<span style="color:#00D">10</span>)
sleep <span style="color:#00D">1</span>
logger.error <span style="color:#036;font-weight:bold">DimmerItem1</span>.eql?(<span style="color:#00D">10</span>) <span style="color:#777"># =&gt; false. It compares the _item_ object not its state</span>
logger.error <span style="color:#036;font-weight:bold">DimmerItem1</span>.eql?(items[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">DimmerItem1</span><span style="color:#710">'</span></span>]) <span style="color:#777"># =&gt; true. It compares the _item_ object</span>
logger.error <span style="color:#036;font-weight:bold">DimmerItem1</span>.state.eql?(<span style="color:#036;font-weight:bold">ON</span>) <span style="color:#777"># =&gt; false</span>
logger.error <span style="color:#036;font-weight:bold">DimmerItem1</span>.state.eql?(<span style="color:#00D">10</span>) <span style="color:#777"># =&gt; false</span>
logger.error <span style="color:#036;font-weight:bold">DimmerItem1</span>.state.eql?(<span style="color:#036;font-weight:bold">PercentType</span>.new(<span style="color:#00D">10</span>)) <span style="color:#777"># =&gt; true</span>
</code></pre>
<h5>Strict Type-Comparisons <!-- raw HTML omitted --></h5>
<p>Sometimes it is critical to know the exact command being sent.
For example, a rule may need to distinguish between <span class='object_link'><a href="OpenHAB/Core/Types/OnOffType.html#ON-constant" title="OpenHAB::Core::Types::OnOffType::ON (constant)">ON</a></span> vs. a <span class='object_link'><a href="OpenHAB/Core/Types/PercentType.html" title="OpenHAB::Core::Types::PercentType (class)">PercentType</a></span> command.
In this instance, Ruby's case equality operator <code>===</code> can be used.
It will only evaluate to true if the two operands have the same type.
The strict type comparison applies to Ruby's <code>case</code> statement because it is implemented using the case equality operator <code>===</code>.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">command</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  received_command <span style="color:#036;font-weight:bold">DimmerItem1</span>
  run <span style="color:#080;font-weight:bold">do</span> |event|
    <span style="color:#080;font-weight:bold">case</span> event.command
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#036;font-weight:bold">ON</span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">DimmerItem1 received an ON command</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#036;font-weight:bold">OFF</span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">DimmerItem1 received an OFF command</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#00D">0</span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">DimmerItem1 received 0 percent</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#00D">1</span>..<span style="color:#00D">99</span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">DimmerItem1 received between 1 and 99 percent</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#00D">100</span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">DimmerItem1 received 100 percent</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#036;font-weight:bold">INCREASE</span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Increase</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#036;font-weight:bold">DECREASE</span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Decrease</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#036;font-weight:bold">REFRESH</span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Refresh</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</code></pre>
<p>Regular expressions can still be used on a <span class='object_link'><a href="OpenHAB/Core/Types/StringType.html" title="OpenHAB::Core::Types::StringType (class)">StringType</a></span> command.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">command</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  received_command <span style="color:#036;font-weight:bold">StringItem1</span>
  run <span style="color:#080;font-weight:bold">do</span> |event|
    <span style="color:#080;font-weight:bold">case</span> event.command
    <span style="color:#080;font-weight:bold">when</span> <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">abc</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">then</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Command contains &quot;abc&quot;</span><span style="color:#710">'</span></span>)
    <span style="color:#080;font-weight:bold">else</span> logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Received something else</span><span style="color:#710">'</span></span>)
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">StringItem1</span> &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">123 abc 456</span><span style="color:#710">'</span></span> <span style="color:#777"># This will log 'Command contains &quot;abc&quot;'</span>
</code></pre>
<h4 id="metadata">Metadata</h4>
<p>Metadata is accessed through <span class='object_link'><a href="OpenHAB/Core/Items/Item.html#metadata-instance_method" title="OpenHAB::Core::Items::Item#metadata (method)">Item#metadata</a></span>.</p>
<pre class="code ruby"><code class="ruby">metadata = <span style="color:#036;font-weight:bold">My_Item</span>.metadata[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">namespace</span><span style="color:#710">'</span></span>].value
</code></pre>
<h4 id="persistence">Persistence</h4>
<p><span class='object_link'><a href="OpenHAB/Core/Items/Persistence.html" title="OpenHAB::Core::Items::Persistence (module)">Persistence</a></span> methods are available directly on <span class='object_link'><a href="OpenHAB/Core/Items/Item.html" title="OpenHAB::Core::Items::Item (module)">Items</a></span>.</p>
<pre class="code ruby"><code class="ruby">logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">KitchenDimmer average_since </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span><span style="color:#036;font-weight:bold">KitchenDimmer</span>.average_since(<span style="color:#00D">1</span>.day.ago)<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)
daily_max = <span style="color:#036;font-weight:bold">My_Item</span>.maximum_since(<span style="color:#00D">24</span>.hours.ago)
</code></pre>
<h4 id="semantic-model">Semantic Model</h4>
<p>Many <span class='object_link'><a href="OpenHAB/Core/Items/Semantics.html" title="OpenHAB::Core::Items::Semantics (module)">helper methods</a></span> are available to make it easy to navigate the semantic model to get related items.</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">LivingRoom_Motion</span>.location                            <span style="color:#777"># Location of the motion sensor</span>
                 .equipments(<span style="color:#036;font-weight:bold">Semantics</span>::<span style="color:#036;font-weight:bold">Lightbulb</span>)    <span style="color:#777"># Get all Lightbulb Equipments in the location</span>
                 .members                             <span style="color:#777"># Get all the member items of the equipments</span>
                 .points(<span style="color:#036;font-weight:bold">Semantics</span>::<span style="color:#036;font-weight:bold">Switch</span>)           <span style="color:#777"># Select only items that are Switch Points</span>
                 .on                                  <span style="color:#777"># Send an ON command to the items</span>
</code></pre>
<h4 id="linked-things">Linked Things</h4>
<p>If an <span class='object_link'><a href="OpenHAB/Core/Items/Item.html" title="OpenHAB::Core::Items::Item (module)">Item</a></span> is linked to a <span class='object_link'><a href="OpenHAB/Core/Things/Thing.html" title="OpenHAB::Core::Things::Thing (module)">Thing</a></span>, you can easily retrieve it.</p>
<pre class="code ruby"><code class="ruby">linked_thing = <span style="color:#036;font-weight:bold">My_Item</span>.thing
thing_uid = <span style="color:#036;font-weight:bold">My_Item</span>.thing.uid
</code></pre>
<p>An item can be linked to multiple things:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">My_Item</span>.things.each <span style="color:#080;font-weight:bold">do</span> |thing|
  logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Thing: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>thing.uid<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h4 id="item-builder">Item Builder</h4>
<p>New items can be created via <span class='object_link'><a href="OpenHAB/Core/Items/Registry.html#build-instance_method" title="OpenHAB::Core::Items::Registry#build (method)">items.build</a></span>.
Note that by default items are not persisted to storage, and will be removed when the script unloads.</p>
<pre class="code ruby"><code class="ruby">items.build <span style="color:#080;font-weight:bold">do</span>
  switch_item <span style="color:#036;font-weight:bold">MySwitch</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My Switch</span><span style="color:#710">&quot;</span></span>
  switch_item <span style="color:#036;font-weight:bold">NotAutoupdating</span>, <span style="color:#606">autoupdate</span>: <span style="color:#069">false</span>, <span style="color:#606">channel</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">mqtt:topic:1#light</span><span style="color:#710">&quot;</span></span>
  group_item <span style="color:#036;font-weight:bold">MyGroup</span> <span style="color:#080;font-weight:bold">do</span>
    contact_item <span style="color:#036;font-weight:bold">ItemInGroup</span>, <span style="color:#606">channel</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">binding:thing#channel</span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#777"># passing `thing` to a group item will automatically use it as the base</span>
  <span style="color:#777"># for item channels</span>
  group_item <span style="color:#036;font-weight:bold">Equipment</span>, <span style="color:#606">tags</span>: <span style="color:#036;font-weight:bold">Semantics</span>::<span style="color:#036;font-weight:bold">HVAC</span>, <span style="color:#606">thing</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">binding:thing</span><span style="color:#710">&quot;</span></span>
    string_item <span style="color:#036;font-weight:bold">Mode</span>, <span style="color:#606">tags</span>: <span style="color:#036;font-weight:bold">Semantics</span>::<span style="color:#036;font-weight:bold">Control</span>, <span style="color:#606">channel</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">mode</span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h3 id="things">Things</h3>
<p>The <span class='object_link'><a href="OpenHAB/DSL.html#things-class_method" title="OpenHAB::DSL.things (method)">things</a></span> object allows interactions with openHAB things.</p>
<p>Get Thing Status:</p>
<pre class="code ruby"><code class="ruby">things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">lgwebos:WebOSTV:main-tv</span><span style="color:#710">'</span></span>].status
</code></pre>
<p>Check if Thing is Online:</p>
<pre class="code ruby"><code class="ruby">things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">lgwebos:WebOSTV:main-tv</span><span style="color:#710">'</span></span>].online?
</code></pre>
<p>or</p>
<pre class="code ruby"><code class="ruby">things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">lgwebos:WebOSTV:main-tv</span><span style="color:#710">'</span></span>].status == <span style="color:#036;font-weight:bold">ThingStatus</span>::<span style="color:#036;font-weight:bold">ONLINE</span>
</code></pre>
<p>Enable/Disable a Thing:</p>
<pre class="code ruby"><code class="ruby">thing = things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">lgwebos:WebOSTV:main-tv</span><span style="color:#710">'</span></span>]

thing.disable
logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">TV enabled: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>thing.enabled?<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>

thing.enable
logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">TV enabled: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>thing.enabled?<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>
</code></pre>
<h3 id="actions">Actions</h3>
<p><a href="https://www.openhab.org/docs/configuration/actions.html">openHAB built-in actions</a> are available via the <span class='object_link'><a href="OpenHAB/Core/Actions.html" title="OpenHAB::Core::Actions (module)">Actions</a></span> module, or they can be called directly.
Thing actions can be called directly on the <span class='object_link'><a href="OpenHAB/Core/Things/Thing.html" title="OpenHAB::Core::Things::Thing (module)">Thing</a></span>.</p>
<p>Publish an MQTT Message:</p>
<pre class="code ruby"><code class="ruby">things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">mqtt:broker:mybroker</span><span style="color:#710">'</span></span>].publish_mqtt(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">topic/name</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">payload</span><span style="color:#710">'</span></span>)
</code></pre>
<p>Send an Email:</p>
<pre class="code ruby"><code class="ruby">things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">mail:smtp:mymailthing</span><span style="color:#710">'</span></span>].send_mail(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">me@example.com</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Subject</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">message body</span><span style="color:#710">'</span></span>)
</code></pre>
<p>Play Sound Through the Default Audio Sink:</p>
<pre class="code ruby"><code class="ruby">play_sound <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sound_file.mp3</span><span style="color:#710">'</span></span>
</code></pre>
<p>Execute a Command:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#036;font-weight:bold">Exec</span>.execute_command_line(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/path/to/program</span><span style="color:#710">'</span></span>)
</code></pre>
<h3 id="logging">Logging</h3>
<p>The JRuby Scripting addon has a global <code>logger</code> object for logging.</p>
<pre class="code text"><code class="text">log:set DEBUG org.openhab.automation.jrubyscripting.script
</code></pre>
<p>The default logger name for UI rules is <code>org.openhab.automation.jrubyscripting.script</code>.
For file-based rules, it's based on the rule's ID, such as <code>org.openhab.automation.jrubyscripting.rule.myrule.rb:15</code>
This can be changed by assigning a new logger locally.</p>
<p>Please be aware that messages might not appear in the logs if the logger name does not start with <code>org.openhab</code>.
This behaviour is due to <a href="https://logging.apache.org/log4j/2.x/">log4j2</a> requiring definition for each logger prefix.</p>
<pre class="code ruby"><code class="ruby">logger = <span style="color:#036;font-weight:bold">OpenHAB</span>::<span style="color:#036;font-weight:bold">Log</span>.logger(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.openhab.custom</span><span style="color:#710">&quot;</span></span>)
</code></pre>
<p>The <span class='object_link'><a href="OpenHAB/Logger.html" title="OpenHAB::Logger (class)">logger</a></span> is similar to a standard <a href="https://ruby-doc.org/stdlib-3.1.2/libdoc/logger/rdoc/Logger.html">Ruby Logger</a>.
Supported logging functions include:</p>
<ul>
<li><code>logger.log(severity, obj)</code></li>
<li><code>logger.info(obj)</code></li>
<li><code>logger.warn(obj)</code></li>
<li><code>logger.error(obj)</code></li>
<li><code>logger.debug(obj)</code></li>
<li><code>logger.trace(obj)</code></li>
</ul>
<p><code>obj</code> is any Ruby (or Java) object.
<code>#to_s</code> (or <code>toString()</code> if it's a Java object) is called on <code>obj</code>, and the result is output to the openHAB log.
Additionally, all of these methods can take a <a href="https://ruby-doc.com/docs/ProgrammingRuby/html/tut_containers.html#S2">Ruby block</a> instead, which will only be called if logging is enabled at the given level, and the result of the block will be treated as the log message.</p>
<h3 id="timers">Timers</h3>
<pre class="code ruby"><code class="ruby">sleep <span style="color:#60E">1.5</span> <span style="color:#777"># sleep for 1.5 seconds</span>
</code></pre>
<p>See Ruby docs on <a href="https://ruby-doc.org/core-2.6/Kernel.html#method-i-sleep">sleep</a>.</p>
<p><code>sleep</code> should be avoided if possible. A <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#delay-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#delay (method)">delay</a></span> can be inserted in between two execution blocks to achieve the same result. This delay is implemented with a timer.
This is available only on file-based rules.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">delay something</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  on_load
  run { logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">This will run immediately</span><span style="color:#710">&quot;</span></span> }
  delay <span style="color:#00D">10</span>.seconds
  run { logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">This will run 10 seconds after</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Alternatively a timer can be used in either a file-based rule or in a UI based rule using <span class='object_link'><a href="OpenHAB/DSL.html#after-class_method" title="OpenHAB::DSL.after (method)">after</a></span>.
After takes a <a href="#durations">Duration</a>, e.g. <code>10.minutes</code> instead of using ZonedDateTime.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">simple timer</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed <span style="color:#036;font-weight:bold">Watering_System</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span>
  run <span style="color:#080;font-weight:bold">do</span>
    after(<span style="color:#00D">5</span>.minutes) { <span style="color:#036;font-weight:bold">Watering_System</span>.off }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>When a script is unloaded, all created timers are automatically cancelled.</p>
<h4>Accessing Variables <!-- raw HTML omitted --></h4>
<p>You can access all variables of the current context in the created timers.</p>
<p>Note: Variables can be mutated (changed) after the timer has been created.
Be aware that this can lead to unattended side effects, e.g. when you change the variable after timer creation, which can make debugging quite difficult!</p>
<pre class="code ruby"><code class="ruby">my_var = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello world!</span><span style="color:#710">&quot;</span></span>;

<span style="color:#777"># Schedule a timer that expires in ten seconds</span>
after(<span style="color:#00D">10</span>.seconds) <span style="color:#080;font-weight:bold">do</span>
  logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Timer expired with my_var = '</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>my_var<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">'</span><span style="color:#710">&quot;</span></span>)
<span style="color:#080;font-weight:bold">end</span>

my_var = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello mutation!</span><span style="color:#710">&quot;</span></span> <span style="color:#777"># When the timer runs, it will log &quot;Hello mutation!&quot; instead of &quot;Hello world!&quot;</span>
</code></pre>
<h4>Reschedule a Timer <!-- raw HTML omitted --></h4>
<p>A timer can be rescheduled inside the timer body</p>
<pre class="code ruby"><code class="ruby">after(<span style="color:#00D">3</span>.minutes) <span style="color:#080;font-weight:bold">do</span> |timer|
  <span style="color:#036;font-weight:bold">My_Light</span>.on
  timer.reschedule <span style="color:#777"># This will reschedule it for the same initial duration, i.e. 3 minutes in this case</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Or it can be rescheduled from outside the timer</p>
<pre class="code ruby"><code class="ruby">my_timer = after(<span style="color:#00D">3</span>.minutes) <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#036;font-weight:bold">My_Light</span>.on
<span style="color:#080;font-weight:bold">end</span>

my_timer.reschedule <span style="color:#777"># Use the same initial duration</span>
</code></pre>
<p>It can be rescheduled to a different duration</p>
<pre class="code ruby"><code class="ruby">after(<span style="color:#00D">3</span>.minutes) <span style="color:#080;font-weight:bold">do</span> |timer|
  <span style="color:#036;font-weight:bold">My_Light</span>.on
  my_timer.reschedule(<span style="color:#00D">1</span>.minute)
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>It can also be canceled:</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">cancel timer</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed <span style="color:#036;font-weight:bold">Light_Item</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">OFF</span>
  run { my_timer&amp;.cancel }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h4>Manage Multiple Timers <!-- raw HTML omitted --></h4>
<p>Multiple timers can be managed in the traditional way by storing the timer objects in a Hash:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#33B">@timers</span> ||= {}

<span style="color:#080;font-weight:bold">if</span> <span style="color:#33B">@timers</span>[event.item]
  <span style="color:#33B">@timers</span>[event.item].reschedule 
<span style="color:#080;font-weight:bold">else</span>
  <span style="color:#33B">@timers</span>[event.item] = after <span style="color:#00D">3</span>.minutes <span style="color:#080;font-weight:bold">do</span> <span style="color:#777"># Use the triggering item as the timer ID</span>
    event.item.off
    <span style="color:#33B">@timers</span>.delete(event.item)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>However, a built in mechanism is available to help manage multiple timers, and is done in a thread-safe manner.
This is done using timer IDs.
The following rule automatically finds and reschedules the timer matching the same ID, which corresponds to each group member.</p>
<pre class="code ruby"><code class="ruby">after <span style="color:#00D">3</span>.minutes, <span style="color:#606">id</span>: event.item <span style="color:#080;font-weight:bold">do</span> <span style="color:#777"># Use the triggering item as the timer ID</span>
  event.item.off
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Furthermore, you can manipulate the managed timers using the built-in <span class='object_link'><a href="OpenHAB/DSL/TimerManager.html" title="OpenHAB::DSL::TimerManager (class)">timers</a></span> object.</p>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># timers is a special object to access the timers created with an id</span>
rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">cancel all timers</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  received_command <span style="color:#036;font-weight:bold">Cancel_All_Timers</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span> <span style="color:#777"># Send a command to this item to cancel all timers</span>
  run <span style="color:#080;font-weight:bold">do</span>
    gOutdoorLights.members.each <span style="color:#080;font-weight:bold">do</span> |item_as_timer_id|
      timers.cancel(item_as_timer_id)
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">reschedule all timers</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  received_command <span style="color:#036;font-weight:bold">Reschedule_All_Timers</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span> <span style="color:#777"># Send a command to this item to restart all timers</span>
  run <span style="color:#080;font-weight:bold">do</span>
    gOutdoorLights.members.each <span style="color:#080;font-weight:bold">do</span> |item_as_timer_id|
      timers.reschedule(item_as_timer_id)
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h3 id="cache">Cache</h3>
<p>The <span class='object_link'><a href="OpenHAB/DSL.html#shared_cache-class_method" title="OpenHAB::DSL.shared_cache (method)">shared_cache</a></span> object provides a cache that can be used to set and retrieve objects that will be persisted between reloads of scripts, and available between different rules.
It acts similarly to a regular Ruby Hash.
Just be wary of Ruby-only data types (such as Symbols) that won't be accessible between different scripts.</p>
<p>Get a previously set object with a default value:</p>
<pre class="code ruby"><code class="ruby">counter_object = shared_cache.compute_if_absent(<span style="color:#A60">:counter</span>) { { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">times</span><span style="color:#710">&quot;</span></span> =&gt; <span style="color:#00D">0</span> } }
logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Count: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>counter_object[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">times</span><span style="color:#710">&quot;</span></span>] += <span style="color:#00D">1</span><span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
</span></span></code></pre>
<p>Get a previously set object, or assign it (this version is subject to race conditions with other scripts):</p>
<pre class="code ruby"><code class="ruby">counter_object = shared_cache[<span style="color:#A60">:counter</span>] ||= { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">times</span><span style="color:#710">&quot;</span></span> =&gt; <span style="color:#00D">0</span> }
logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Count: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>counter_object[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">times</span><span style="color:#710">&quot;</span></span>] += <span style="color:#00D">1</span><span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
</span></span></code></pre>
<p>Get a previously set object with a default value, without assigning it (this version has an even longer amount of time between fetchig the value and assigning it):</p>
<pre class="code ruby"><code class="ruby">count = shared_count.fetch(<span style="color:#A60">:counter</span>) { <span style="color:#00D">0</span> }
shared_count[<span style="color:#A60">:counter</span>] = count + <span style="color:#00D">1</span>
</code></pre>
<h3 id="time">Time</h3>
<p>Several options are available for time related code, including but not limited to:</p>
<ul>
<li>Java <span class='object_link'><a href="OpenHAB/CoreExt/Java/LocalDate.html" title="OpenHAB::CoreExt::Java::LocalDate (class)">LocalDate</a></span> - represents a date with no time</li>
<li>Java <span class='object_link'><a href="OpenHAB/CoreExt/Java/LocalTime.html" title="OpenHAB::CoreExt::Java::LocalTime (class)">LocalTime</a></span> - represents a time with no date</li>
<li>Java <span class='object_link'><a href="OpenHAB/CoreExt/Java/Month.html" title="OpenHAB::CoreExt::Java::Month (class)">Month</a></span></li>
<li>Java <span class='object_link'><a href="OpenHAB/CoreExt/Java/MonthDay.html" title="OpenHAB::CoreExt::Java::MonthDay (class)">MonthDay</a></span> - represents a date with no time or year</li>
<li>Java <span class='object_link'><a href="OpenHAB/CoreExt/Java/ZonedDateTime.html" title="OpenHAB::CoreExt::Java::ZonedDateTime (class)">ZonedDateTime</a></span> - represents a specific instance with a date and time</li>
<li>Java <span class='object_link'><a href="OpenHAB/CoreExt/Java/Duration.html" title="OpenHAB::CoreExt::Java::Duration (class)">Duration</a></span></li>
<li>Java <span class='object_link'><a href="OpenHAB/CoreExt/Java/Period.html" title="OpenHAB::CoreExt::Java::Period (class)">Period</a></span></li>
<li>Ruby <a href="https://ruby-doc.org/stdlib-2.6.8/libdoc/date/rdoc/Date.html">Date</a> - represents a date with no time</li>
<li>Ruby <a href="https://ruby-doc.org/core/Time.html">Time</a> - represents a specific instant with a date and time</li>
<li>Ruby <a href="https://ruby-doc.org/core/DateTime.html">DateTime</a> - represents a specific instant with a date and time</li>
</ul>
<h4>Durations <!-- raw HTML omitted --></h4>
<p>Ruby <a href="https://ruby-doc.org/core-2.6.8/Integer.html">integers</a> and <a href="https://ruby-doc.org/core-2.6.8/Float.html">floats</a> are extended with several methods to support durations.
These methods create a new <span class='object_link'><a href="OpenHAB/CoreExt/Java/Duration.html" title="OpenHAB::CoreExt::Java::Duration (class)">Duration</a></span> or <span class='object_link'><a href="OpenHAB/CoreExt/Java/Period.html" title="OpenHAB::CoreExt::Java::Period (class)">Period</a></span> object that is used by the <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#every-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#every (method)">every</a></span> trigger, <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#delay-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#delay (method)">delay</a></span> block, the for option of <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#changed-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#changed (method)">changed</a></span> triggers, and <span class='object_link'><a href="OpenHAB/Core/Timer.html" title="OpenHAB::Core::Timer (class)">timers</a></span>.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">run every 30 seconds</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  every <span style="color:#00D">30</span>.seconds
  run { logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello</span><span style="color:#710">&quot;</span></span>) }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Warn about open door</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed <span style="color:#036;font-weight:bold">FrontDoor</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">OPEN</span>, <span style="color:#606">for</span>: <span style="color:#00D">10</span>.minutes
  run { |event| logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item.name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> has been open for 10 minutes</span><span style="color:#710">&quot;</span></span>) }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Timer example</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  on_load
  run <span style="color:#080;font-weight:bold">do</span>
    after(<span style="color:#00D">3</span>.hours) { logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">3 hours have passed</span><span style="color:#710">&quot;</span></span>) }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h4>Time Comparisons, Conversions, and Arithmetic <!-- raw HTML omitted --></h4>
<p>Comparisons, conversions and arithmetic are automatic between Java and Ruby types.
Note that anytime you do a comparison between a type with more specific data, and a type missing specific data, the comparison is done as if the more specific data is at the beginning of its period.
I.e. comparing a time to a month, the month will be treated as 00:00:00 on the first day of the month.
When comparing with a type that's missing more generic data, it will be filled in from the other object.
I.e. comparing a time to a month, the month will be assumed to be in the same year as the time.</p>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># Get current date/time</span>
now = <span style="color:#036;font-weight:bold">ZonedDateTime</span>.now
one_hour_from_now = <span style="color:#036;font-weight:bold">ZonedDateTime</span>.now + <span style="color:#00D">30</span>.minutes
one_hour_from_now = <span style="color:#00D">1</span>.hour.from_now <span style="color:#777"># or use the simpler helper method that also returns a ZonedDateTime</span>
<span style="color:#777"># Or use Ruby time</span>
ruby_now = <span style="color:#036;font-weight:bold">Time</span>.now

<span style="color:#777"># Compare them</span>
<span style="color:#080;font-weight:bold">if</span> one_hour_from_now &gt; now
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">As it should be</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># Comparing Ruby Time and ZonedDateTime works just fine</span>
<span style="color:#080;font-weight:bold">if</span> one_hour_from_now &gt; ruby_now
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">It works too</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">Time</span>.now &gt; <span style="color:#036;font-weight:bold">LocalTime</span>.parse(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">7am</span><span style="color:#710">'</span></span>)
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Wake up!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">MonthDay</span>.now == <span style="color:#036;font-weight:bold">MonthDay</span>.parse(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">02-14</span><span style="color:#710">'</span></span>)
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Happy Valentine's Day!</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># Ranges can cross midnight</span>
<span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">Time</span>.now.between?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">10pm</span><span style="color:#710">'</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">5am</span><span style="color:#710">'</span></span>)
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Sleep time</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># Explicit conversions</span>
<span style="color:#036;font-weight:bold">ZonedDateTime</span>.now.to_time
<span style="color:#036;font-weight:bold">Time</span>.now.to_zoned_date_time
</code></pre>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># You can parse string as time</span>
wake_up_time = <span style="color:#036;font-weight:bold">LocalTime</span>.parse(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">6:00 am</span><span style="color:#710">&quot;</span></span>)

<span style="color:#777"># Compare now against LocalTime</span>
<span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">ZonedDateTime</span>.now &gt;= wake_up_time
  <span style="color:#036;font-weight:bold">Wake_Up_Alarm</span>.on
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># Even compare against Ruby Time</span>
<span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">Time</span>.now &gt;= wake_up_time
  <span style="color:#036;font-weight:bold">Wake_Up_Alarm</span>.on
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># Get today's start of the day (midnight)</span>
start_of_day = <span style="color:#036;font-weight:bold">ZonedDateTime</span>.now.with(<span style="color:#036;font-weight:bold">LocalTime</span>::<span style="color:#036;font-weight:bold">MIDNIGHT</span>)
<span style="color:#777"># or</span>
start_of_day = <span style="color:#036;font-weight:bold">LocalTime</span>::<span style="color:#036;font-weight:bold">MIDNIGHT</span>.to_zoned_date_time
</code></pre>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># Comparing ZonedDateTime against LocalTime with `&lt;`</span>
max = <span style="color:#036;font-weight:bold">Solar_Power</span>.maximum_since(<span style="color:#00D">24</span>.hours.ago)
<span style="color:#080;font-weight:bold">if</span> max.timestamp &lt; <span style="color:#036;font-weight:bold">LocalTime</span>::<span style="color:#036;font-weight:bold">NOON</span>
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Max solar power </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>max<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> happened before noon, at: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>max.timestamp<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># Comparing Time against ZonedDateTime with `&gt;`</span>
sunset = things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">astro:sun:home</span><span style="color:#710">&quot;</span></span>].get_event_time(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">SUN_SET</span><span style="color:#710">&quot;</span></span>, <span style="color:#069">nil</span>, <span style="color:#069">nil</span>)
<span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">Time</span>.now &gt; sunset 
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">it is after sunset</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># Subtracting Duration from Time and comparing Time against ZonedDateTime</span>
<span style="color:#036;font-weight:bold">Motion_Sensor</span>.last_update &lt; <span style="color:#036;font-weight:bold">Time</span>.now - <span style="color:#00D">10</span>.minutes
<span style="color:#777"># Alternatively:</span>
<span style="color:#036;font-weight:bold">Motion_Sensor</span>.last_update &lt; <span style="color:#00D">10</span>.minutes.ago

<span style="color:#777"># Finding The Duration Between Two Times</span>
elapsed_time = <span style="color:#036;font-weight:bold">Time</span>.now - <span style="color:#036;font-weight:bold">Motion_Sensor</span>.last_update
<span style="color:#777"># Alternatively:</span>
elapsed_time = <span style="color:#036;font-weight:bold">ZonedDateTime</span>.now - <span style="color:#036;font-weight:bold">Motion_Sensor</span>.last_update

<span style="color:#777"># Using `-` operator with ZonedDateTime</span>
<span style="color:#777"># Comparing two ZonedDateTime using `&lt;` </span>
<span style="color:#036;font-weight:bold">Motion_Sensor</span>.last_update &lt; <span style="color:#036;font-weight:bold">Light_Item</span>.last_update - <span style="color:#00D">10</span>.minutes
<span style="color:#777"># is the same as:</span>
<span style="color:#036;font-weight:bold">Motion_Sensor</span>.last_update.before?(<span style="color:#036;font-weight:bold">Light_Item</span>.last_update.minus_minutes(<span style="color:#00D">10</span>))
</code></pre>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># Getting Epoch Second</span>
<span style="color:#036;font-weight:bold">Time</span>.now.to_i
<span style="color:#036;font-weight:bold">ZonedDateTime</span>.now.to_i
<span style="color:#036;font-weight:bold">ZonedDateTime</span>.now.to_epoch_second

<span style="color:#777"># Convert Epoch second to time</span>
<span style="color:#036;font-weight:bold">Time</span>.at(<span style="color:#00D">1669684403</span>)

<span style="color:#777"># Convert Epoch second to ZonedDateTime</span>
<span style="color:#036;font-weight:bold">Time</span>.at(<span style="color:#00D">1669684403</span>).to_zoned_date_time
<span style="color:#777"># or</span>
java.time.Instant.of_epoch_second(<span style="color:#00D">1669684403</span>).at_zone(<span style="color:#036;font-weight:bold">ZoneId</span>.system_default)
</code></pre>
<h4>Ranges <!-- raw HTML omitted --></h4>
<p>Ranges of date time objects work as expected.
Make sure to use <code>#cover?</code> instead of <code>#include?</code> to do a simple comparison, instead of generating an array and searching it linearly.
Ranges of non-absolute, &quot;circular&quot; types (<span class='object_link'><a href="OpenHAB/CoreExt/Java/LocalTime.html" title="OpenHAB::CoreExt::Java::LocalTime (class)">LocalTime</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/Month.html" title="OpenHAB::CoreExt::Java::Month (class)">Month</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/MonthDay.html" title="OpenHAB::CoreExt::Java::MonthDay (class)">MonthDay</a></span>) are smart enough to automatically handle boundary issues.
Coarse types (like <span class='object_link'><a href="OpenHAB/CoreExt/Java/LocalDate.html" title="OpenHAB::CoreExt::Java::LocalDate (class)">LocalDate</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/Month.html" title="OpenHAB::CoreExt::Java::Month (class)">Month</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/MonthDay.html" title="OpenHAB::CoreExt::Java::MonthDay (class)">MonthDay</a></span>) will also work correctly when checking against a more specific type.
To easily parse strings into date-time ranges, use the <span class='object_link'><a href="OpenHAB/DSL.html#between-class_method" title="OpenHAB::DSL.between (method)">OpenHAB::DSL.between</a></span> helper.
<span class='object_link'><a href="OpenHAB/CoreExt/Java/Duration.html" title="OpenHAB::CoreExt::Java::Duration (class)">Duration</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/ZonedDateTime.html" title="OpenHAB::CoreExt::Java::ZonedDateTime (class)">ZonedDateTime</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/LocalTime.html" title="OpenHAB::CoreExt::Java::LocalTime (class)">LocalTime</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/LocalDate.html" title="OpenHAB::CoreExt::Java::LocalDate (class)">LocalDate</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/MonthDay.html" title="OpenHAB::CoreExt::Java::MonthDay (class)">MonthDay</a></span>, <span class='object_link'><a href="OpenHAB/CoreExt/Java/Month.html" title="OpenHAB::CoreExt::Java::Month (class)">Month</a></span>, <span class='object_link'><a href="Time.html" title="Time (class)">Time</a></span>, <span class='object_link'><a href="Date.html" title="Date (class)">Date</a></span>, and <span class='object_link'><a href="DateTime.html" title="DateTime (class)">DateTime</a></span> classes include <span class='object_link'><a href="OpenHAB/CoreExt/Between.html#between%3F-instance_method" title="OpenHAB::CoreExt::Between#between? (method)">between?</a></span> method that accepts a range of string or any of the date/time objects.</p>
<pre class="code ruby"><code class="ruby">between(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">10:00</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">14:00</span><span style="color:#710">&quot;</span></span>).cover?(<span style="color:#036;font-weight:bold">Time</span>.now)
between(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">11pm</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1am</span><span style="color:#710">&quot;</span></span>).cover?(<span style="color:#036;font-weight:bold">Time</span>.now)

<span style="color:#777"># Or use the alternative syntax:</span>
<span style="color:#036;font-weight:bold">Time</span>.now.between?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">10:00</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">14:00</span><span style="color:#710">&quot;</span></span>)
<span style="color:#036;font-weight:bold">Time</span>.now.between?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">11pm</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1am</span><span style="color:#710">&quot;</span></span>)

<span style="color:#080;font-weight:bold">case</span> <span style="color:#036;font-weight:bold">Time</span>.now
<span style="color:#080;font-weight:bold">when</span> between(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">6:00</span><span style="color:#710">&quot;</span></span>...<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">12:00</span><span style="color:#710">&quot;</span></span>)
  logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Morning Time</span><span style="color:#710">&quot;</span></span>)
<span style="color:#080;font-weight:bold">when</span> between(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">12:00</span><span style="color:#710">'</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">15:00</span><span style="color:#710">'</span></span>)
  logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Afternoon</span><span style="color:#710">&quot;</span></span>)
<span style="color:#080;font-weight:bold">else</span>
  logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Not in time range</span><span style="color:#710">&quot;</span></span>)
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># Compare against Month</span>
<span style="color:#036;font-weight:bold">Time</span>.now.between?(<span style="color:#036;font-weight:bold">Month</span>::<span style="color:#036;font-weight:bold">NOVEMBER</span>..<span style="color:#036;font-weight:bold">Month</span>::<span style="color:#036;font-weight:bold">DECEMBER</span>)
<span style="color:#036;font-weight:bold">Date</span>.today.between?(<span style="color:#036;font-weight:bold">Month</span>::<span style="color:#036;font-weight:bold">NOVEMBER</span>..<span style="color:#036;font-weight:bold">Month</span>::<span style="color:#036;font-weight:bold">DECEMBER</span>)
<span style="color:#036;font-weight:bold">ZonedDateTime</span>.now.between?(<span style="color:#036;font-weight:bold">Month</span>::<span style="color:#036;font-weight:bold">NOVEMBER</span>..<span style="color:#036;font-weight:bold">Month</span>::<span style="color:#036;font-weight:bold">DECEMBER</span>)

<span style="color:#777"># Compare against MonthDay</span>
<span style="color:#036;font-weight:bold">Time</span>.now.between?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">05-01</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">12-01</span><span style="color:#710">&quot;</span></span>)

<span style="color:#777"># Compare against time of day</span>
<span style="color:#036;font-weight:bold">Time</span>.now.between?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">5am</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">11pm</span><span style="color:#710">&quot;</span></span>)
</code></pre>
<h3 id="gems">Gems</h3>
<p><a href="https://bundler.io/">Bundler</a> is integrated, enabling any <a href="https://rubygems.org/">Ruby gem</a> compatible with JRuby to be used within rules. This permits easy access to the vast ecosystem of libraries within the Ruby community.
Gems are available using the <a href="https://bundler.io/guides/bundler_in_a_single_file_ruby_script.html">inline bundler syntax</a>.
The require statement can be omitted.</p>
<pre class="code ruby"><code class="ruby">gemfile <span style="color:#080;font-weight:bold">do</span>
  source <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">https://rubygems.org</span><span style="color:#710">'</span></span>
  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">json</span><span style="color:#710">'</span></span>, <span style="color:#606">require</span>: <span style="color:#069">false</span>
  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">nap</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">1.1.0</span><span style="color:#710">'</span></span>, <span style="color:#606">require</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rest</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">The nap gem is at version </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span><span style="color:#036;font-weight:bold">REST</span>::<span style="color:#036;font-weight:bold">VERSION</span><span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)
</code></pre>
<h3 id="shared-code">Shared Code</h3>
<p>If you would like to easily share code among multiple scripts, you can place it in <code>&lt;OPENHAB_CONF&gt;/automation/ruby/lib</code>.
You can then simply <code>require</code> the file from your rules files.
Files located in <code>$RUBYLIB</code> won't be automatically loaded individually by openHAB, only when you <code>require</code> them.</p>
<p><code>automation/ruby/myrule.rb</code> OR a UI Rule's script:</p>
<pre class="code ruby"><code class="ruby">require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_lib</span><span style="color:#710">&quot;</span></span>

logger.info(my_lib_version)
</code></pre>
<p><code>automation/ruby/lib/my_lib.rb</code></p>
<pre class="code ruby"><code class="ruby"><span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">my_lib_version</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1.0</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h2 id="file-based-rules">File Based Rules</h2>
<h3 id="basic-rule-structure">Basic Rule Structure</h3>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/Builder.html" title="OpenHAB::DSL::Rules::Builder (class)">OpenHAB::DSL::Rules::Builder</a></span> for full details.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">name</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  &lt;one <span style="color:#080;font-weight:bold">or</span> more triggers&gt;
  &lt;one <span style="color:#080;font-weight:bold">or</span> more execution blocks&gt;
  &lt;zero <span style="color:#080;font-weight:bold">or</span> more guards <span style="color:#080;font-weight:bold">or</span> conditions&gt;
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Jump to: <a href="#rule-triggers">Rule Triggers</a>, <a href="#rule-executions">Rule Executions</a>, <a href="#rule-conditions">Rule Conditions</a></p>
<h3 id="rule-triggers">Rule Triggers</h3>
<h4 id="item-or-thing-changed">Item or Thing Changed</h4>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Log (or notify) when the secret door is open</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed <span style="color:#036;font-weight:bold">SecretDoor</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">OPEN</span>
  run { |event| logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> is opened</span><span style="color:#710">&quot;</span></span>) }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Log when Fronius Inverter goes offline</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">fronius:bridge:mybridge</span><span style="color:#710">&quot;</span></span>], <span style="color:#606">from</span>: <span style="color:#A60">:online</span>, <span style="color:#606">to</span>: <span style="color:#A60">:offline</span>
  run { |event| logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Thing </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.uid<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> went </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.status<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">&quot;</span></span>) }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#changed-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#changed (method)">#changed</a></span></p>
<h5>Detecting Change Duration <!-- raw HTML omitted --></h5>
<p>Only execute a rule when an item state changed and stayed the same for a period of time. This method
can only be done using a file-based rule.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Garage Door Alert</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed <span style="color:#036;font-weight:bold">GarageDoor</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">OPEN</span>, <span style="color:#606">for</span>: <span style="color:#00D">20</span>.minutes
  run { say <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">The garage door has been open for 20 minutes!</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h4 id="item-updated">Item Updated</h4>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Calculate</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  updated <span style="color:#036;font-weight:bold">Camera_Event_Data</span>
  run <span style="color:#080;font-weight:bold">do</span> |event|
    logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Camera event: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#updated-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#updated (method)">#updated</a></span></p>
<h4 id="item-received-a-command">Item Received a Command</h4>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Received a command</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  received_command <span style="color:#036;font-weight:bold">DoorBell</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span>
  run <span style="color:#080;font-weight:bold">do</span> |event|
    notify <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Someone pressed the door bell</span><span style="color:#710">&quot;</span></span>
    play_sound <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">doorbell.mp3</span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#received_command-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#received_command (method)">#received_command</a></span></p>
<h4 id="member-of-group-trigger">Member-of-Group Trigger</h4>
<p>Add <code>.members</code> to the GroupItem in order to trigger on its members.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Trigger by Member of</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed gGroupName.members
  run <span style="color:#080;font-weight:bold">do</span> |event|
    logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Triggered item: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item.name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h4 id="script-is-loaded">Script is Loaded</h4>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">initialize things</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  on_load <span style="color:#777"># This triggers whenever the script (re)loads</span>
  run { logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Here we go!</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#on_load-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#on_load (method)">#on_load</a></span></p>
<h4 id="openhab-system-started">openHAB System Started</h4>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">System startup rule</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  on_start <span style="color:#606">at_level</span>: <span style="color:#00D">80</span>
  run { logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">I'm glad to be alive!</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#on_start-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#on_start (method)">#on_start</a></span></p>
<h4 id="cron-trigger">Cron Trigger</h4>
<p>Traditional cron trigger:</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">cron rule</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  cron <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">0 0,15 15-19 L * ?</span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
  run { logger.info </span><span style="color:#710">&quot;</span></span><span style="color:#036;font-weight:bold">Cron</span> run<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> }
end
</span></span></code></pre>
<p>Or an easier syntax:</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">cron rule</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  cron <span style="color:#606">second</span>: <span style="color:#00D">0</span>, <span style="color:#606">minute</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">0,15</span><span style="color:#710">&quot;</span></span>, <span style="color:#606">hour</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">15-19</span><span style="color:#710">&quot;</span></span>, <span style="color:#606">dom</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">L</span><span style="color:#710">&quot;</span></span>
  run { logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cron run</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#cron-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#cron (method)">#cron</a></span></p>
<h5><code>every</code> Trigger</h5>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">run every day</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  every <span style="color:#A60">:day</span>, <span style="color:#606">at</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">2:35pm</span><span style="color:#710">&quot;</span></span>
  run { <span style="color:#036;font-weight:bold">Amazon_Echo_TTS</span> &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">It's time to pick up the kids!</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">run every 5 mins</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  every <span style="color:#00D">5</span>.minutes
  run { logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openHAB is awesome</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Anniversary Reminder</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  every <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">10-15</span><span style="color:#710">&quot;</span></span> <span style="color:#777"># This takes a MM-DD syntax to trigger on 15th of October at midnight</span>
  run <span style="color:#080;font-weight:bold">do</span>
    things[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">mail:smtp:mymailthing</span><span style="color:#710">&quot;</span></span>].send_mail(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">me@example.com</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Anniversary Reminder!</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Today is your anniversary!</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#every-instance_method" title="OpenHAB::DSL::Rules::BuilderDSL#every (method)">#every</a></span></p>
<h4 id="other-triggers">Other Triggers</h4>
<p>There are more triggers supported by this library. See the
<span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#Triggers-group" title="group::OpenHAB::DSL::Rules::BuilderDSL::Triggers (group)">full list of supported triggers</a></span>.</p>
<h4 id="combining-multiple-triggers">Combining Multiple Triggers</h4>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">multiple triggers</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed <span style="color:#036;font-weight:bold">Switch1</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span>
  changed <span style="color:#036;font-weight:bold">Switch2</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span>
  run { |event| logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Switch: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item.name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> changed to: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>When the trigger conditions are the same, the triggers can be combined.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">multiple triggers</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed <span style="color:#036;font-weight:bold">Switch1</span>, <span style="color:#036;font-weight:bold">Switch2</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span>
  run { |event| logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Switch: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item.name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> changed to: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h4 id="combining-multiple-conditions">Combining Multiple Conditions</h4>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">multiple conditions</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed <span style="color:#036;font-weight:bold">Button_Action</span>, <span style="color:#606">to</span>: [<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">single</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">double</span><span style="color:#710">&quot;</span></span>]
  run { |event| logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Action: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h3 id="rule-conditions">Rule Conditions</h3>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">motion sensor</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  updated <span style="color:#036;font-weight:bold">Motion_Sensor</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span>
  only_if { <span style="color:#036;font-weight:bold">Sensor_Enable</span>.on? } <span style="color:#777"># Run rule only if Sensor_Enable item is ON</span>
  not_if { <span style="color:#036;font-weight:bold">Sun_Elevation</span>.positive? } <span style="color:#777"># and not while the sun is up</span>
  run { <span style="color:#036;font-weight:bold">LightItem</span>.on }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Restrict Rule Executions to Certain Time of Day:</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">doorbell</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  updated <span style="color:#036;font-weight:bold">DoorBell_Button</span>, <span style="color:#606">to</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">single</span><span style="color:#710">&quot;</span></span>
  between <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">6am</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">8:30pm</span><span style="color:#710">&quot;</span></span>
  run { play_sound <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">doorbell_chime.mp3</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/BuilderDSL.html#Guards-group" title="group::OpenHAB::DSL::Rules::BuilderDSL::Guards (group)">Rule Guards</a></span></p>
<h3 id="rule-executions">Rule Executions</h3>
<p>Execution blocks are executed when a rule is triggered and all the rule conditions are met.
Multiple execution blocks can be specified. This can be useful especially when using a delay execution
block inbetween two run or triggered blocks.</p>
<h4 id="run-execution-block">Run Execution Block</h4>
<p>A run execution block is the most commonly used execution block. It provides the full <a href="#event-object">event object</a>
to the block.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Rule with a run block</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  received_command <span style="color:#036;font-weight:bold">SwitchItem1</span>
  run <span style="color:#080;font-weight:bold">do</span> |event|
    logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> received this command: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.command<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h4 id="triggered-execution-block">Triggered Execution Block</h4>
<p>A triggered execution block passes the <code>TriggeringItem</code> object directly to the block. It is handy when combined with
Ruby's pretzel-colon operator to act directly on the object.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Limit the duration of TV watching</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed gTVPower.members, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span>, <span style="color:#606">for</span>: <span style="color:#00D">2</span>.hours
  triggered(&amp;<span style="color:#A60">:off</span>)
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h4 id="delay-execution-block">Delay Execution Block</h4>
<p>A delay exection block is useful for adding a delay inbetween rule executions or even at the beginning of the
trigger event without having to manually create a timer. Unlike <code>sleep</code>, a delay block does not block
the current executing thread. It actually sets a timer for you behind the scenes.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Check for offline things 15 minutes after openHAB had started</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  on_start
  delay <span style="color:#00D">15</span>.minutes
  run <span style="color:#080;font-weight:bold">do</span>
    offline_things = things.select(&amp;<span style="color:#A60">:offline?</span>).map(&amp;<span style="color:#A60">:uid</span>).join(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>)
    notify(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Things that are still offline: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>offline_things<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<!-- raw HTML omitted -->
<h3 id="terse-rules">Terse Rules</h3>
<p>A rule with a trigger and an execution block can be created with just one line.</p>
<pre class="code ruby"><code class="ruby">received_command(<span style="color:#036;font-weight:bold">My_Switch</span>, <span style="color:#606">to</span>: <span style="color:#036;font-weight:bold">ON</span>) { <span style="color:#036;font-weight:bold">My_Light</span>.on }
</code></pre>
<p>See <span class='object_link'><a href="OpenHAB/DSL/Rules/Terse.html" title="OpenHAB::DSL::Rules::Terse (module)">Terse Rules</a></span> for full details.</p>
<h3 id="rule-manipulations">Rule Manipulations</h3>
<p>Get the UID of a Rule</p>
<pre class="code ruby"><code class="ruby">rule_obj = rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">my rule name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  received_command <span style="color:#036;font-weight:bold">My_Item</span>
  run <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#777"># rule code here</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

rule_uid = rule_obj.uid
</code></pre>
<p>A rule's UID can also be specified at rule creation</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my rule name</span><span style="color:#710">&quot;</span></span>, <span style="color:#606">id</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_unique_rule_uid</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>Get the UID of a Rule by Name</p>
<pre class="code ruby"><code class="ruby">rule_uid = rules.find { |rule| rule.name == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">This is the name of my rule</span><span style="color:#710">'</span></span> }.uid
</code></pre>
<p>Enable or Disable a Rule by UID</p>
<pre class="code ruby"><code class="ruby">rules[rule_uid].enable
rules[rule_uid].disable
</code></pre>
<p>Run a Rule by UID</p>
<pre class="code ruby"><code class="ruby">rules[rule_uid].trigger
</code></pre>
<h3 id="early-exit-from-a-rule">Early Exit From a Rule</h3>
<p>You can use <code>next</code> within a file-based rule, because it's in a block:</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">doorbell</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  updated <span style="color:#036;font-weight:bold">DoorBell_Button</span>, <span style="color:#606">to</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">single</span><span style="color:#710">&quot;</span></span>
  run <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">next</span> <span style="color:#080;font-weight:bold">unless</span> <span style="color:#036;font-weight:bold">Time</span>.now.between?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">6am</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">8:30pm</span><span style="color:#710">&quot;</span></span>)

    play_sound <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">doorbell_chime.mp3</span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</code></pre>
<p>Use <code>return</code> within a UI rule:</p>
<pre class="code ruby"><code class="ruby"><span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">unless</span> <span style="color:#036;font-weight:bold">Time</span>.now.between?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">6am</span><span style="color:#710">&quot;</span></span>..<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">8:30pm</span><span style="color:#710">&quot;</span></span>)

play_sound <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">doorbell_chime.mp3</span><span style="color:#710">&quot;</span></span>
</code></pre>
<h3 id="dynamic-generation-of-rules">Dynamic Generation of Rules</h3>
<p>The rule definition itself is just Ruby code, which means you can use code to generate your rules.
Take care when doing this as the the items/groups are processed when the rules file is processed, meaning that new items/groups will not automatically generate new rules.</p>
<pre class="code ruby"><code class="ruby">rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Log whenever a Virtual Switch Changes</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  items.select { |item| item.is_a?(<span style="color:#036;font-weight:bold">Switch</span>) }
       .select { |item| item.label&amp;.include?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Virtual</span><span style="color:#710">&quot;</span></span>) }
       .each <span style="color:#080;font-weight:bold">do</span> |item|
         changed item
       <span style="color:#080;font-weight:bold">end</span>

  run { |event| logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item.name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> changed from </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.was<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> to </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>This rule is effectively the same:</p>
<pre class="code ruby"><code class="ruby">virtual_switches = items.select { |item| item.is_a?(<span style="color:#036;font-weight:bold">Switch</span>) }
                        .select { |item| item.label&amp;.include?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Virtual</span><span style="color:#710">&quot;</span></span>) }

rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Log whenever a Virtual Switch Changes 2</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
  changed(*virtual_switches)
  run { |event| logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item.name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> changed from </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.was<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> to </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> 2</span><span style="color:#710">&quot;</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p>This will accomplish the same thing, but create a new rule for each virtual switch:</p>
<pre class="code ruby"><code class="ruby">virtual_switches = items.select { |item| item.is_a?(<span style="color:#036;font-weight:bold">Switch</span>) }
                        .select { |item| item.label&amp;.include?(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Virtual</span><span style="color:#710">&quot;</span></span>) }

virtual_switches.each <span style="color:#080;font-weight:bold">do</span> |switch|
  rule <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Log whenever a </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>switch.label<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> Changes</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">do</span>
    changed switch
    run { |event| logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.item.name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> changed from </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.was<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> to </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>event.state<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> 2</span><span style="color:#710">&quot;</span></span> }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h3 id="hooks">Hooks</h3>
<p>File based scripts can also register <span class='object_link'><a href="OpenHAB/Core/ScriptHandling.html" title="OpenHAB::Core::ScriptHandling (module)">hooks</a></span> that will be called when the script has completed loading (<code>script_loaded</code>) and when it gets unloaded (<code>script_unloaded</code>).</p>
<pre class="code ruby"><code class="ruby">x = <span style="color:#00D">1</span>

script_loaded <span style="color:#080;font-weight:bold">do</span>
  logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">script loaded!</span><span style="color:#710">&quot;</span></span>)
  logger.info(x) <span style="color:#777"># this will log 2, since it won't execute until the entire script loads.</span>
<span style="color:#080;font-weight:bold">end</span>

x = <span style="color:#00D">2</span>

script_unloaded <span style="color:#080;font-weight:bold">do</span>
  logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">script unloaded</span><span style="color:#710">&quot;</span></span>)
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<h3 id="transformations">Transformations</h3>
<p>This add-on also provides the necessary infrastructure to use Ruby for writing <a href="https://www.openhab.org/docs/configuration/transformations.html">transformations</a>.
Once the addon is installed, you can create a Ruby file in the <code>$OPENHAB_CONF/transform</code> directory, with the extension <code>.script</code>.
It's important that the extension is <code>.script</code> so that the core <code>SCRIPT</code> transform service will recognize it.
When referencing the file, you need to specify the <code>SCRIPT</code> transform, with <code>rb</code> as the script type: <code>SCRIPT(rb:mytransform.script):%s</code>.
You can also specify additional variables to be set in the script using a URI-like query syntax: <code>SCRIPT(rb:mytransform.script?a=1b=c):%s</code> in order to share a single script with slightly different parameters for different items.</p>
<p><strong>Note</strong>: Due to an <a href="https://github.com/jruby/jruby/issues/5876">issue</a> in the current version of JRuby, you will need to begin your script with <code>input ||= nil</code> (and <code>a ||= nil</code> etc. for additional query variables) so that JRuby will recognize the variables as variables--rather than method calls--when it's parsing the script.
Otherwise you will get errors like <code>(NameError) undefined local variable or method 'input' for main:Object</code>.</p>
<p><code>compass.script</code></p>
<pre class="code ruby"><code class="ruby">input ||= <span style="color:#069">nil</span>
<span style="color:#036;font-weight:bold">DIRECTIONS</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%w[</span><span style="color:#D20">N NE E SE S SW W NW N</span><span style="color:#710">]</span></span>.freeze

<span style="color:#080;font-weight:bold">if</span> input.nil? || input == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">NULL</span><span style="color:#710">&quot;</span></span> || input == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">UNDEF</span><span style="color:#710">&quot;</span></span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">-</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">else</span>
  cardinal = <span style="color:#036;font-weight:bold">DIRECTIONS</span>[(input.to_f / <span style="color:#00D">45</span>).round]
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>cardinal<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> (</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>input.to_i<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">°)</span><span style="color:#710">&quot;</span></span>
<span style="color:#080;font-weight:bold">end</span>
</code></pre>
<p><code>weather.items</code></p>
<pre class="code Xtend"><code class="Xtend">Number:Angle Exterior_WindDirection &quot;Wind Direction [SCRIPT(rb:compass.script):%s]&quot; &lt;wind&gt;
</code></pre>
<p>Given a state of <code>82 °</code>, this will produce a formatted state of <code>E (82°)</code>.</p>
<h2 id="calling-java-from-jruby">Calling Java From JRuby</h2>
<p>JRuby can access almost any Java object that's available in the current JVM.
This is how the library is implemented internally.</p>
<pre class="code ruby"><code class="ruby"><span style="color:#777"># you can `java_import` classes and interfaces, which will become Ruby constants</span>
java_import java.time.format.DateTimeFormatter

formatter = <span style="color:#036;font-weight:bold">DateTimeFormatter</span>.of_pattern(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">yyyy MM dd</span><span style="color:#710">&quot;</span></span>)

<span style="color:#777"># or you can just reference them directly to avoid polluting the global namespace</span>
formatter = java.time.format.DateTimeFormatter.of_pattern(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">yyyy MM dd</span><span style="color:#710">&quot;</span></span>)
</code></pre>
<p>See <a href="https://github.com/jruby/jruby/wiki/CallingJavaFromJRuby">full documentation from JRuby</a></p>
</div></div>

      <div id="footer">
  Generated on Wed Dec  7 15:28:42 2022 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.28 (ruby-3.1.3).
</div>

    </div>
  </body>
</html>